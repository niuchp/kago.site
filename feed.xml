<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.6.2">Jekyll</generator><link href="https://kago.site/feed.xml" rel="self" type="application/atom+xml" /><link href="https://kago.site/" rel="alternate" type="text/html" /><updated>2018-01-26T17:55:22+08:00</updated><id>https://kago.site/</id><title type="html">阅后即忘 | 牛昌平的个人博客</title><subtitle>点滴积累，聚沙成塔</subtitle><author><name>Barry New</name></author><entry><title type="html">用 Travis CI 免费自动构建和部署 Jekyll</title><link href="https://kago.site/2018/01/25/travis-ci-for-jekyll/" rel="alternate" type="text/html" title="用 Travis CI 免费自动构建和部署 Jekyll" /><published>2018-01-25T00:00:00+08:00</published><updated>2018-01-25T00:00:00+08:00</updated><id>https://kago.site/2018/01/25/travis-ci-for-jekyll</id><content type="html" xml:base="https://kago.site/2018/01/25/travis-ci-for-jekyll/">&lt;blockquote&gt;
  &lt;p&gt;前一段时间搭建了个人博客，一直说要记录一下搭建过程，由于懒拖到现在……我的博客的搭建过程分为两阶段，第一阶段是利用 Github Pages 蹭免费环境，启动博客；第二阶段是利用 Travsi 持续集成，把环境迁到自己的云服务器。之所以迁到自己的云服务器，主要原因是 Github Pages 禁止百度蜘蛛，意味着百度不能收录网站，搜索站点名称的时候就搜索不到，这对于我这种喜欢“炫耀”的银来说必须不能接受。本文介绍在云服务器中搭建博客的完整过程。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;整个搭建过程思路如下：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;fork 博客到 Github ，修改博客属性&lt;/li&gt;
  &lt;li&gt;本地 Markdown 编写博客，push md 文件到 Github&lt;/li&gt;
  &lt;li&gt;配置 Travis CI 执行自动编译，生成 html 文件&lt;/li&gt;
  &lt;li&gt;编译后 Travis CI push html文件到新的 Github 仓库&lt;/li&gt;
  &lt;li&gt;Travis CI 重启云服务器中的容器，拉取 Github 中的 html 文件完成更新&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;1-利用-github-pages-搭建个人博客&quot;&gt;1. 利用 Github Pages 搭建个人博客&lt;/h3&gt;

&lt;p&gt;利用 Github Pages 搭建个人博客在网上已经有很多资料了，有的人可能会觉得这是在占小便宜，其实完全是多虑了， Github 是鼓励个人建站滴，所以放下大胆的享受红利吧。&lt;/p&gt;

&lt;p&gt;想要享受 Github 的红利当然前提条件是要有 Github 账户，注册方法就不提了，我们直接开始 fork 博客模板。&lt;/p&gt;

&lt;p&gt;这里我使用的是大佬&lt;a href=&quot;https://github.com/mzlogin/mzlogin.github.io&quot;&gt;马壮&lt;/a&gt;修改样式后的模板，fork 以后需要做以下修改：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;正确设置项目名称与分支。&lt;/p&gt;

    &lt;p&gt;按照 GitHub Pages 的规定，名称为 username.github.io 的项目的 master 分支，或者其它名称的项目的 gh-pages 分支可以自动生成 GitHub Pages 页面。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;修改域名。&lt;/p&gt;

    &lt;p&gt;如果你需要绑定自己的域名，那么修改 CNAME 文件的内容；如果不需要绑定自己的域名，那么删掉 CNAME 文件。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;修改配置。&lt;/p&gt;

    &lt;p&gt;网站的配置基本都集中在 _config.yml 文件中，将其中与个人信息相关的部分替换成你自己的，比如网站的 url、title、subtitle 和第三方评论模块的配置等。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;评论模块:&lt;br /&gt;
 目前支持 disqus、gitment 和 gitalk，选用其中一种就可以了。可参看以前的博文 &lt;a href=&quot;https://kago.site/2017/12/09/gitment/&quot;&gt;「jekyll中添加gitment留言板」&lt;/a&gt;。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;删除原有的文章与图片。&lt;/p&gt;

    &lt;p&gt;如下文件夹中除了 template.md 文件外，都可以全部删除，然后添加你自己的内容。&lt;br /&gt;
     _posts 文件夹中是已发布的博客文章。&lt;br /&gt;
     _drafts 文件夹中是尚未发布的博客文章。&lt;br /&gt;
     _wiki 文件夹中是已发布的 wiki 页面。&lt;br /&gt;
     images 文件夹中是文章和页面里使用的图片。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;修改「关于」页面。&lt;/p&gt;

    &lt;p&gt;pages/about.md 文件内容对应网站的「关于」页面，里面的内容多为个人相关，将它们替换成你自己的信息，包括 _data 目录下的 skills.yml 和 social.yml 文件里的数据。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;修改完后，增加 CNAME 中的域名与 Github Pages 解析关系，登录到购买域名的网站增加域名到 192.30.252.153 的解析。其中， 192.30.252.153 是Github Pages 的服务器地址。接下来，就可以打开浏览器访问你的博客啦~&lt;/p&gt;

&lt;p&gt;Clone 你的网站代码库到本地，使用常见的编辑器（本人使用的是 vs code ）写博客，然后再push到 Github 即可。由于该该博客模板是利用 Jekyll 实现的静态网站，支持 Markdown ，这简直是太方便了，按照 Markdown 的语法尽情的写博客就好了， Github Pages 会自动识别 Markdown 格式的。&lt;/p&gt;

&lt;h3 id=&quot;2-利用-travis-持续集成&quot;&gt;2. 利用 Travis 持续集成&lt;/h3&gt;

&lt;h4 id=&quot;21-添加-github-仓库至-travis&quot;&gt;2.1 添加 Github 仓库至 Travis&lt;/h4&gt;

&lt;p&gt;利用 Travis 部分要感谢 &lt;a href=&quot;https://mritd.me/&quot;&gt;漠然&lt;/a&gt; 在博客中分析的他的实现方法。&lt;/p&gt;

&lt;p&gt;注册 Travis CI 账号，然后点击最左侧 + 按钮添加项目&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/增加仓库.png&quot; alt=&quot;增加仓库&quot; /&gt;&lt;/p&gt;

&lt;p&gt;选择添加到 Travis 的仓库&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/选择仓库.png&quot; alt=&quot;选择仓库&quot; /&gt;&lt;/p&gt;

&lt;p&gt;点击仓库旁的设置&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/配置仓库.png&quot; alt=&quot;配置仓库&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;22-创建travisyaml&quot;&gt;2.2 创建.travis.yaml&lt;/h4&gt;
&lt;p&gt;在博客的根路径下创建 .travis.yaml 配置文件，实现基本集成配置：&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;language&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ruby&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;rvm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2.3.3&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle install&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle exec jekyll build&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;branches&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;master&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;global&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;NOKOGIRI_USE_SYSTEM_LIBRARIES=true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;更多travis.yaml配置参考官方文档 &lt;a href=&quot;https://docs.travis-ci.com/&quot;&gt;https://docs.travis-ci.com/&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&quot;23-添加-deploy-keys&quot;&gt;2.3 添加 deploy keys&lt;/h4&gt;

&lt;p&gt;在 .travis.yaml 中进行加密配置，是为了使 Travis CI 可以免密码访问 Github&lt;/p&gt;

&lt;p&gt;生成密钥对，并添加公钥至 Github 的Deploy keys&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssh-keygen &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; rsa &lt;span class=&quot;nt&quot;&gt;-C&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;youremail@example.com&quot;&lt;/span&gt;  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/images/posts/travis/deploy_keys.png&quot; alt=&quot;deploy_keys&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;24-安装并登陆travis&quot;&gt;2.4 安装并登陆travis&lt;/h4&gt;

&lt;p&gt;此步骤主要是为了生成 travis 的 keys&lt;/p&gt;

&lt;p&gt;安装&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gem install travis
travis login &lt;span class=&quot;nt&quot;&gt;--auto&lt;/span&gt;
Successfully logged &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;as niuchp!
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;25-加密&quot;&gt;2.5 加密&lt;/h4&gt;

&lt;p&gt;在加密之前我们先在项目根目录下需有 .travis.yaml 文件。加密的就是第一步生成的密钥id_rsa&lt;/p&gt;

&lt;p&gt;拷贝在 2.3 步骤中生成密钥对至项目根目录下，并执行：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;travis encrypt-file ssh_key &lt;span class=&quot;nt&quot;&gt;--add&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这时候看最后一句**Commit all changes to your .travis.yml.。&lt;/p&gt;

&lt;p&gt;我们的 .travis.yaml 文件中多了一句:(私人内容使用XXX代替)&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;openssl aes-256-cbc -K $encrypted_XXXXXXXX_key -iv $encrypted_XXXXXXXX_iv -in id_rsa.enc -out ~/.ssh/id_rsa -d&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;例如：&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;language&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ruby&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;rvm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2.3.3&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;before_install&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;openssl aes-256-cbc -K $encrypted_xxxxxxx_key -iv $encrypted_xxxxxxx_iv -in id_rsa.enc -out ~/.ssh/id_rsa -d&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;chmod 600 ~/.ssh/id_rsa&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle install&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle exec jekyll build&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;global&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;NOKOGIRI_USE_SYSTEM_LIBRARIES=true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;再次查看我们的 Travis CI 网页，发现多了一些变化&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/加密.png&quot; alt=&quot;加密&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;记得要删除 id_rsa 文件，私钥文件已经由 id_rsa.enc 替代&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;26-配置自动更新&quot;&gt;2.6 配置自动更新&lt;/h4&gt;

&lt;p&gt;自动更新部分是利用 Travis CI push 编译后的文件至一个新的代码库，重启容器触发 git pull 实现的。&lt;/p&gt;

&lt;p&gt;Travis CI push 静态文件到 Github 通过 Github 的 token 实现授权，代码如下&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;after_success&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git clone https://github.com/niuchp/kago.site.git&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cd kago.site &amp;amp;&amp;amp; rm -rf * &amp;amp;&amp;amp; cp -r ../_site/* .&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git config user.name &quot;niuchp&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git config user.email &quot;niuchp@126.com&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git add --all .&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git commit -m &quot;Travis CI Auto Builder&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git push --force https://$JEKYLL_GITHUB_TOKEN@github.com/niuchp/kago.site.git master&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ssh root@kago.site &quot;docker restart kago_site&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;注意： 配置文件中的kago.site.git为新仓库！&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;其中，JEKYLL_GITHUB_TOKEN 是从 Github 授权得到的，然后给于相应权限即可&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/travis_deploy_keys.png&quot; alt=&quot;travis_deploy_keys&quot; /&gt;&lt;/p&gt;

&lt;p&gt;得到JEKYLL_GITHUB_TOKEN后在 Travish CI的项目配置中添加环境变量$JEKYLL_GITHUB_TOKEN 如下图:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/env.png&quot; alt=&quot;env&quot; /&gt;&lt;/p&gt;

&lt;p&gt;完整的 .travis.yaml 配置文件如下：&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;language&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ruby&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;rvm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2.3.3&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;before_install&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;openssl aes-256-cbc -K $encrypted_xxxxxxx_key -iv $encrypted_xxxxxxx_iv -in id_rsa.enc -out ~/.ssh/id_rsa -d&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;chmod 600 ~/.ssh/id_rsa&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle install&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle exec jekyll build&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;after_success&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git clone https://github.com/niuchp/kago.site.git&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cd kago.site &amp;amp;&amp;amp; rm -rf * &amp;amp;&amp;amp; cp -r ../_site/* .&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git config user.name &quot;niuchp&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git config user.email &quot;niuchp@126.com&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git add --all .&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git commit -m &quot;Travis CI Auto Builder&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git push --force https://$JEKYLL_GITHUB_TOKEN@github.com/niuchp/kago.site.git master&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ssh root@kago.site &quot;docker restart kago_site&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;branches&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;master&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;global&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;NOKOGIRI_USE_SYSTEM_LIBRARIES=true&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;addons&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;ssh_known_hosts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kago.site&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;3-配置-docker-容器&quot;&gt;3. 配置 docker 容器&lt;/h3&gt;

&lt;p&gt;Travis CI 持续集成后会重启云服务器中的 docker 容器，触发 git pull 完成更新。&lt;/p&gt;

&lt;p&gt;Dockerfile&lt;/p&gt;

&lt;div class=&quot;language-dockerfile highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; nginx:1.13.6-alpine &lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;LABEL&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; maintainer=&quot;Barry New &amp;lt;niuchp@126.com&amp;gt;&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ARG&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; TZ='Asia/Shanghai'&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; TZ ${TZ}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apk upgrade &lt;span class=&quot;nt&quot;&gt;--update&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apk add bash git &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; /usr/share/nginx/html &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; git clone https://github.com/niuchp/kago.site.git /usr/share/nginx/html &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; ln &lt;span class=&quot;nt&quot;&gt;-sf&lt;/span&gt; /usr/share/zoneinfo/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; /etc/localtime &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/timezone &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; /var/cache/apk/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; entrypoint.sh /entrypoint.sh&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;COPY&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; default.conf /etc/nginx/conf.d/&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /usr/share/nginx/html&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;CMD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; [&quot;/entrypoint.sh&quot;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;entrypoint.sh&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;

git pull
nginx &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;daemon off;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;default.conf&lt;/p&gt;

&lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; {
    &lt;span class=&quot;n&quot;&gt;listen&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;443&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;server_name&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;localhost&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl_certificate&lt;/span&gt;  /&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;share&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nginx&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;ssl&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;fullchain&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;cer&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl_certificate_key&lt;/span&gt;  /&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;share&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nginx&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;ssl&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;;
    &lt;span class=&quot;c&quot;&gt;#charset koi8-r;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#access_log  /var/log/nginx/host.access.log  main;
&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; / {
        &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;   /&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;share&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nginx&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;htm&lt;/span&gt;;
    }

    &lt;span class=&quot;c&quot;&gt;#error_page  404              /404.html;
&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# redirect server error pages to the static page /50x.html
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;error_page&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;502&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;503&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;504&lt;/span&gt;  /&lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; = /&lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt; {
        &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;   /&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;share&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nginx&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt;;
    }

    &lt;span class=&quot;c&quot;&gt;# proxy the PHP scripts to Apache listening on 127.0.0.1:80
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#location ~ \.php$ {
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    proxy_pass   http://127.0.0.1;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#}
&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#location ~ \.php$ {
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    root           html;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    fastcgi_pass   127.0.0.1:9000;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    fastcgi_index  index.php;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    include        fastcgi_params;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#}
&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# deny access to .htaccess files, if Apache's document root
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;# concurs with nginx's one
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#location ~ /\.ht {
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    deny  all;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#}
&lt;/span&gt;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;到此，整个配置过程就结束了，可以通过 git push 触发 Travis CI 进行测试。&lt;/p&gt;</content><author><name>Barry New</name></author><summary type="html">前一段时间搭建了个人博客，一直说要记录一下搭建过程，由于懒拖到现在……我的博客的搭建过程分为两阶段，第一阶段是利用 Github Pages 蹭免费环境，启动博客；第二阶段是利用 Travsi 持续集成，把环境迁到自己的云服务器。之所以迁到自己的云服务器，主要原因是 Github Pages 禁止百度蜘蛛，意味着百度不能收录网站，搜索站点名称的时候就搜索不到，这对于我这种喜欢“炫耀”的银来说必须不能接受。本文介绍在云服务器中搭建博客的完整过程。</summary></entry><entry><title type="html">etcd集群安装及基本操作</title><link href="https://kago.site/2018/01/24/etcd-cluster/" rel="alternate" type="text/html" title="etcd集群安装及基本操作" /><published>2018-01-24T00:00:00+08:00</published><updated>2018-01-24T00:00:00+08:00</updated><id>https://kago.site/2018/01/24/etcd-cluster</id><content type="html" xml:base="https://kago.site/2018/01/24/etcd-cluster/">&lt;blockquote&gt;
  &lt;p&gt;etcd 是 kubernetes 中默认使用的键值存储系统，相当于是 kubernetes 集群的大脑，那么 etcd 怎么安装使用呢？下面为常用的集群配置及基本操作。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;etcd 是一个用于共享配置和服务的高可用键值存储系统，由 CoreOS 使用开发并作为 CoreOS 的基础服务启动。etcd 的灵感来源于 Apache ZooKeeper 和 doozer，其特点：&lt;/p&gt;

&lt;p&gt;· 简单：可用 curl 进行操作（HTTP+JSON） &lt;br /&gt;
· 安全：可使用 SSL 客户端证书验证&lt;br /&gt;
· 快速：基准测试在每个实例 1000 次写入每秒&lt;br /&gt;
· 可靠: 使用 Raft 协议来进行合理的分布式&lt;/p&gt;

&lt;h3 id=&quot;官方网站&quot;&gt;官方网站&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/coreos/etcd/&quot;&gt;https://github.com/coreos/etcd/&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;安装环境&quot;&gt;安装环境&lt;/h3&gt;

&lt;p&gt;操作系统： CentOS7&lt;br /&gt;
etcd版本： 3.0.4&lt;br /&gt;
3节点集群示例&lt;br /&gt;
etcd0: 192.168.8.101&lt;br /&gt;
etcd1: 192.168.8.102&lt;br /&gt;
etcd2: 192.168.8.103&lt;/p&gt;

&lt;h3 id=&quot;安装etcd集群&quot;&gt;安装etcd集群&lt;/h3&gt;

&lt;h4 id=&quot;一安装软件包&quot;&gt;一、安装软件包&lt;/h4&gt;

&lt;p&gt;&lt;em&gt;三个节点都执行&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-sSL&lt;/span&gt; https://github.com/coreos/etcd/releases/download/v3.0.4/etcd-v3.0.4-linux-amd64.tar.gz|tar &lt;span class=&quot;nt&quot;&gt;-xvf&lt;/span&gt; - &lt;span class=&quot;nt&quot;&gt;--gzip&lt;/span&gt;
cp &lt;span class=&quot;nt&quot;&gt;-af&lt;/span&gt; etcd-v3.0.4-linux-amd64/&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;etcd,etcdctl&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; /usr/local/bin
chmod +x /usr/local/bin/&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;etcd,etcdctl&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h4 id=&quot;二配置etcd&quot;&gt;二、配置etcd&lt;/h4&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/clustering.md&quot;&gt;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/clustering.md&lt;/a&gt;&lt;br /&gt;
cluster帮助文档&lt;br /&gt;
etcd-v3.0.4-linux-amd64/Documentation/op-guide/clustering.md&lt;br /&gt;
This guide will cover the following mechanisms for bootstrapping an etcd cluster:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;#static&quot;&gt;Static&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#etcd-discovery&quot;&gt;etcd Discovery&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#dns-discovery&quot;&gt;DNS Discovery&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;目前支持三种发现方式，Static适用于有固定IP的主机节点，etcd Discovery适用于DHCP环境，DNS Discovery依赖DNS SRV记录&lt;/p&gt;

&lt;p&gt;&lt;em&gt;提示：etcd支持ssl/tls,详见官方文档&lt;br /&gt;
&lt;a href=&quot;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/security.md&quot;&gt;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/security.md&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;以下使用static方式&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;节点一: etcd0: 192.168.8.101&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd0 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-advertise-peer-urls&lt;/span&gt; http://192.168.8.101:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.101:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.101:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.101:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-token&lt;/span&gt; etcd-cluster-1 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;etcd0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380,etcd1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380,etcd2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-state&lt;/span&gt; new
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;节点二: etcd1: 192.168.8.102&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd1 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-advertise-peer-urls&lt;/span&gt; http://192.168.8.102:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.102:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.102:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.102:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-token&lt;/span&gt; etcd-cluster-1 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;etcd0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380,etcd1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380,etcd2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-state&lt;/span&gt; new
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;节点三: etcd2: 192.168.8.103&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd2 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-advertise-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.103:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.103:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-token&lt;/span&gt; etcd-cluster-1 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;etcd0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380,etcd1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380,etcd2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-state&lt;/span&gt; new 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;说明&lt;/strong&gt;&lt;br /&gt;
2379 是用于监听客户端请求，2380 用于集群通信，–data-dir指定数据存放目录&lt;br /&gt;
注意:&lt;br /&gt;
上面的初始化只是在集群初始化时运行一次，之后服务有重启，必须要去除掉initial参数，否则报错。&lt;br /&gt;
请使用如下类似命令:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd2   &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.103:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.103:2379 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;三systemd管控&quot;&gt;三、systemd管控&lt;/h4&gt;

&lt;p&gt;创建 etcd.service  （以 etcd0 为例）&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/lib/systemd/system/etcd.service &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;HERE&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
WorkingDirectory=/opt/etcd/
ExecStart=/usr/local/bin/etcd --name etcd0 --data-dir /opt/etcd \
  --initial-advertise-peer-urls http://192.168.8.101:2380 \
  --listen-peer-urls http://192.168.8.101:2380 \
  --listen-client-urls http://192.168.8.101:2379,http://127.0.0.1:2379 \
  --advertise-client-urls http://192.168.8.101:2379 \
  --initial-cluster-token etcd-cluster-1 \
  --initial-cluster etcd0=http://192.168.8.101:2380,etcd1=http://192.168.8.102:2380,etcd2=http://192.168.8.103:2380 \
  --initial-cluster-state new
Restart=on-failure
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;启动etcd服务&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;etcd
Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /usr/lib/systemd/system/etcd.service.
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# systemctl start etcd
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# systemctl status etcd
●etcd.service - Etcd Server
  Loaded: loaded &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;/usr/lib/systemd/system/etcd.service&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; enabled&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; vendor preset: disabled&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  Active: active &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;running&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; since 2018-01-23 15:06:30 CST&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; 8min ago
 Main PID: 12099 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;etcd&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  CGroup: /system.slice/etcd.service
         └─12099 /usr/local/bin/etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd0 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd
......
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;etcd集群管理&quot;&gt;etcd集群管理&lt;/h3&gt;

&lt;p&gt;官方地址&lt;br /&gt;
&lt;a href=&quot;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/maintenance.md&quot;&gt;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/maintenance.md&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nt&quot;&gt;--version&lt;/span&gt;
etcdctl version: 3.0.4
 
 
API version: 2
COMMANDS:
    backup         backup an etcd directory
    cluster-health  check the health of the etcd cluster
    mk            make a new key with a given value
    mkdir          make a new directory
    rm            remove a key or a directory
    rmdir          removes the key &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;it is an empty directory or a key-value pair
    get           retrieve the value of a key
    &lt;span class=&quot;nb&quot;&gt;ls            &lt;/span&gt;retrieve a directory
    &lt;span class=&quot;nb&quot;&gt;set           set &lt;/span&gt;the value of a key
    setdir         create a new directory or update an existing directory TTL
    update         update an existing key with a given value
    updatedir      update an existing directory
    watch          watch a key &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;changes
    exec-watch     watch a key &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;changes and &lt;span class=&quot;nb&quot;&gt;exec &lt;/span&gt;an executable
    member         member add, remove and list subcommands
    import         import a snapshot to a cluster
    user          user add, grant and revoke subcommands
    role          role add, grant and revoke subcommands
    auth          overall auth controls
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;一集群健康状态&quot;&gt;一、集群健康状态&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl cluster-health
member 2947dd07df9e44da is healthy: got healthy result from http://192.168.8.102:2379
member 571bf93ce7760601 is healthy: got healthy result from http://192.168.8.101:2379
member b200a8bec19bd22e is healthy: got healthy result from http://192.168.8.103:2379
cluster is healthy
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;二集群成员查看&quot;&gt;二、集群成员查看&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl member list
2947dd07df9e44da: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd1 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;571bf93ce7760601: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd0 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;b200a8bec19bd22e: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd2 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;三删除集群成员&quot;&gt;三、删除集群成员&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member remove b200a8bec19bd22e 
Removed member 4d11141f72b2744c from cluster
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member list
2947dd07df9e44da: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd1 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;571bf93ce7760601: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd0 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;四添加集群成员&quot;&gt;四、添加集群成员&lt;/h4&gt;
&lt;p&gt;官方说明：
&lt;a href=&quot;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/runtime-configuration.md&quot;&gt;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/runtime-configuration.md&lt;/a&gt;&lt;br /&gt;
&lt;em&gt;注意:步骤很重要，不然会报集群ID不匹配&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member add &lt;span class=&quot;nt&quot;&gt;--help&lt;/span&gt;
NAME:
  etcdctl member add - add a new member to the etcd cluster
USAGE:
  etcdctl member add
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;1.将目标节点添加到集群&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member add etcd2 http://192.168.8.103:2380
Added member named etcd2 with ID 28e0d98e7ec15cd4 to cluster

&lt;span class=&quot;nv&quot;&gt;ETCD_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;etcd2&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_INITIAL_CLUSTER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;etcd2=http://192.168.8.103:2380,etcd1=http://192.168.8.102:2380,etcd0=http://192.168.8.101:2380&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_INITIAL_CLUSTER_STATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;existing&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member list
2947dd07df9e44da: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd1 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;571bf93ce7760601: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd0 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;d4f257d2b5f99b64[unstarted]: &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;此时，集群会为目标节点生成一个唯一的member ID&lt;/p&gt;

&lt;p&gt;2.清空目标节点的data-dir&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]#rm &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; /opt/etcd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;注意:节点删除后，集群中的成员信息会更新，新节点加入集群是作为一个全新的节点加入，如果data-dir有数据，etcd启动时会读取己经存在的数据，启动时仍然用的老member ID,也会造成，集群不无法加入，所以一定要清空新节点的data-dir&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;2016-08-12 01:59:41.084928 E | rafthttp: failed to find member 2947dd07df9e44da &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;cluster ce2f2517679629de
2016-08-12 01:59:41.133698 W | rafthttp: failed to process raft message &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;raft: stopped&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
2016-08-12 01:59:41.135746 W | rafthttp: failed to process raft message &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;raft: stopped&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
2016-08-12 01:59:41.170915 E | rafthttp: failed to find member 2947dd07df9e44da &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;cluster ce2f2517679629de
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.在目标节点上启动etcd&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd2 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--initial-advertise-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.103:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.103:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--initial-cluster-token&lt;/span&gt; etcd-cluster-1 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--initial-cluster&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;etcd0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380,etcd1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380,etcd2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--initial-cluster-state&lt;/span&gt; existing
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;em&gt;注意:这里的initial标记一定要指定为existing,如果为new则会自动生成一个新的member ID,和前面添加节点时生成的ID不一致，故日志中会报节点ID不匹配的错&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member list
28e0d98e7ec15cd4: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd2 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;2947dd07df9e44da: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd1 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;571bf93ce7760601: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd0 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;五增删改查&quot;&gt;五、增删改查&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;foo &lt;span class=&quot;s2&quot;&gt;&quot;bar&quot;&lt;/span&gt;
bar
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl get foo
bar
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl mkdir hello
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt;
/foo
/hello
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt; extended get foo
Key: /foo
Created-Index: 9
Modified-Index: 9
TTL: 0
Index: 10
bar
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt; json get foo
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;get&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;node&quot;&lt;/span&gt;:&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/foo&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;value&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;bar&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;nodes&quot;&lt;/span&gt;:null,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:9,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:9&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;prevNode&quot;&lt;/span&gt;:null&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl update foo &lt;span class=&quot;s2&quot;&gt;&quot;etcd cluster is ok&quot;&lt;/span&gt;
etcd cluster is ok
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl get foo
etcd cluster is ok
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl import &lt;span class=&quot;nt&quot;&gt;--snap&lt;/span&gt;/opt/etcd/member/snap/db 
starting to import snapshot /opt/etcd/member/snap/db with 10 clients
2016-08-12 01:18:17.281921 I | entering dir: /
finished importing 0 keys
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h4 id=&quot;rest-api&quot;&gt;REST API&lt;/h4&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/coreos/etcd/tree/master/Documentation/learning&quot;&gt;https://github.com/coreos/etcd/tree/master/Documentation/learning&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# curl 192.168.8.101:2379/v2/keys 
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;get&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;node&quot;&lt;/span&gt;:&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;dir&quot;&lt;/span&gt;:true,&lt;span class=&quot;s2&quot;&gt;&quot;nodes&quot;&lt;/span&gt;:[&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/foo&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;value&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;etcd cluster is ok&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:28,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:9&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/hello&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;dir&quot;&lt;/span&gt;:true,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:10,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:10&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/registry&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;dir&quot;&lt;/span&gt;:true,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:47,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:47&lt;span class=&quot;o&quot;&gt;}]}}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# curl &lt;span class=&quot;nt&quot;&gt;-fs&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-X&lt;/span&gt; PUT 192.168.8.101:2379/v2/keys/_test
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;set&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;node&quot;&lt;/span&gt;:&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/_test&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;value&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:1439,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:1439&lt;span class=&quot;o&quot;&gt;}}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# curl &lt;span class=&quot;nt&quot;&gt;-X&lt;/span&gt; GET 192.168.8.101:2379/v2/keys/_test
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;get&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;node&quot;&lt;/span&gt;:&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/_test&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;value&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:1439,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:1439&lt;span class=&quot;o&quot;&gt;}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Barry New</name></author><summary type="html">etcd 是 kubernetes 中默认使用的键值存储系统，相当于是 kubernetes 集群的大脑，那么 etcd 怎么安装使用呢？下面为常用的集群配置及基本操作。</summary></entry><entry><title type="html">nip.io域名的使用</title><link href="https://kago.site/2017/12/29/nipio/" rel="alternate" type="text/html" title="nip.io域名的使用" /><published>2017-12-29T00:00:00+08:00</published><updated>2017-12-29T00:00:00+08:00</updated><id>https://kago.site/2017/12/29/nipio</id><content type="html" xml:base="https://kago.site/2017/12/29/nipio/">&lt;blockquote&gt;
  &lt;p&gt;昨天小毛同学告诉我说发现一个很流弊的东西叫 nip.io，可以凭域名自动解析为 IP 地址，极大的方便了 kubernetes 中 ingress 部分的测试。在 cmd 中试了一下还真是好用，记录一下~&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;官方介绍&quot;&gt;官方介绍&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;NIP.IO

Dead simple wildcard DNS for any IP Address

NIP.IO allows you to map any IP Address in the following DNS wildcard entries:

10.0.0.1.nip.io maps to 10.0.0.1
app.10.0.0.1.nip.io maps to 10.0.0.1
customer1.app.10.0.0.1.nip.io maps to 10.0.0.1
customer2.app.10.0.0.1.nip.io maps to 10.0.0.1
otherapp.10.0.0.1.nip.io maps to 10.0.0.1

NIP.IO maps &amp;lt;anything&amp;gt;.&amp;lt;IP Address&amp;gt;.nip.io to the corresponding &amp;lt;IP Address&amp;gt;, even 127.0.0.1.nip.io maps to 127.0.0.1


This service is a blatant rip-off of xip.io, with one big difference: NIP.IO is powered by PowerDNS with a simple, custom PipeBackend. So, it actually works :) (no messy, custom DNS server here!)

The custom PipeBackend is a single script written in Python and the source can be found on XP-Dev.com.

This is a free service provided by Exentrique Solutions (the same guys who run XP-Dev.com which offers Git, Mercurial and Subversion hosting). The infrastructure runs on a couple of Virtual Machines in the US West Coast and Germany.

Feedback is appreciated, just drop us a mail at info@exentriquesolutions.com or use this web form.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;原来 nip.io 像 xip.io 一样是一个欺骗性的映射，可以方便的把 xxx.192.168.1.1.nip.io 这样的域名解析成 192.168.1.1 ，在 web 测试中十分方便。不必频繁地修改 DNS 或者 hosts 文件即可实现域名解析为 IP 地址，尤其在 kubernetes 环境中配置 ingress 的 hosts 部分。
xip.io 和 nip.io 还有一个区别是，nip.io 后端是有 powerDNS ，是实际发生了解析操作。&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;注意：离线模式下不可用哦~&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;实测&quot;&gt;实测&lt;/h3&gt;

&lt;p&gt;使用 cmd 对域名进行了简单测试，结果如下：
&lt;img src=&quot;/images/posts/nipio.png&quot; alt=&quot;cmd测试截图&quot; /&gt;&lt;/p&gt;</content><author><name>Barry New</name></author><summary type="html">昨天小毛同学告诉我说发现一个很流弊的东西叫 nip.io，可以凭域名自动解析为 IP 地址，极大的方便了 kubernetes 中 ingress 部分的测试。在 cmd 中试了一下还真是好用，记录一下~</summary></entry><entry><title type="html">jekyll中添加gitment留言板</title><link href="https://kago.site/2017/12/09/gitment/" rel="alternate" type="text/html" title="jekyll中添加gitment留言板" /><published>2017-12-09T00:00:00+08:00</published><updated>2017-12-09T00:00:00+08:00</updated><id>https://kago.site/2017/12/09/gitment</id><content type="html" xml:base="https://kago.site/2017/12/09/gitment/">&lt;h1 id=&quot;前言&quot;&gt;前言&lt;/h1&gt;
&lt;p&gt;最近使用jekyll搭建了个人博客（https://kago.site），参考网友资料为博客添加了gitment作为留言板，罗列一下基本步骤，希望可以帮到大家。&lt;/p&gt;

&lt;h1 id=&quot;申请github-oauth-application&quot;&gt;申请Github OAuth Application&lt;/h1&gt;
&lt;p&gt;Github头像下拉菜单 &amp;gt; Settings &amp;gt; 左边Developer settings下的OAuth Apps &amp;gt; New OAuth App，填写相关信息：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;Application name, Homepage URL, Application description 都可以随意填写&lt;/li&gt;
  &lt;li&gt;Authorization callback URL 一定要写自己Github Pages的URL&lt;/li&gt;
  &lt;li&gt;填写完上述信息后按Register application按钮，得到Client ID和Client Secret&lt;/li&gt;
  &lt;li&gt;记录Client ID和Client Secret，稍后会用到&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;在jekyll添加调用gitment&quot;&gt;在jekyll添加调用gitment&lt;/h1&gt;
&lt;p&gt;在_layout/目录下的 post.html, 添加一下代码：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;div id=&quot;gitmentContainer&quot;&amp;gt;&amp;lt;/div&amp;gt;
&amp;lt;link rel=&quot;stylesheet&quot; href=&quot;https://imsun.github.io/gitment/style/default.css&quot;&amp;gt;
&amp;lt;script src=&quot;https://imsun.github.io/gitment/dist/gitment.browser.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
&amp;lt;script&amp;gt;
var gitment = new Gitment({
    owner: 'Your GitHub username',
    repo: 'The repo to store comments',
    oauth: {
        client_id: 'Your client ID',
        client_secret: 'Your client secret',
    },
});
gitment.render('gitmentContainer');
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;需要修改的有4个地方&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Your GitHub username：填写你的Github Pages博客所在的github账户名&lt;/li&gt;
  &lt;li&gt;The repo to store comments：填写用来存放评论的github仓库，由于评论是 通过issues来存放的，个人建议这里可以直接填Github Pages个人博客所在的仓库&lt;/li&gt;
  &lt;li&gt;Your client ID：上一步所申请到的应用的Client ID&lt;/li&gt;
  &lt;li&gt;Your client secret：上一步所申请到的应用的Client Secret&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;填写完这4项把代码push到github。&lt;/p&gt;

&lt;h1 id=&quot;为博客初始化留言板&quot;&gt;为博客初始化留言板&lt;/h1&gt;
&lt;p&gt;gitment的原理是为每一遍博文以其URL作为标识创建一个github issue， 对该篇博客的评论就是对这个issue的评论。因此，需要对博客初始化， 初始化后，评论信息会添加到github上对应的issue。&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;上传代码成功后，博客文章下方会出现留言板，显示&lt;code class=&quot;highlighter-rouge&quot;&gt;Error: Comments Not Initialized&lt;/code&gt;,提示需要初始化&lt;/li&gt;
  &lt;li&gt;点击&lt;code class=&quot;highlighter-rouge&quot;&gt;login with github&lt;/code&gt;,使用自己github账号登录，错误信息会变成&lt;code class=&quot;highlighter-rouge&quot;&gt;Initialize Comments&lt;/code&gt;按钮&lt;/li&gt;
  &lt;li&gt;点击按钮，完成对博文的初始化，同时创建相应的issue
&lt;img src=&quot;/images/posts/gitment/gitment.png&quot; alt=&quot;gitment&quot; /&gt;&lt;/li&gt;
&lt;/ol&gt;</content><author><name>Barry New</name></author><summary type="html">前言 最近使用jekyll搭建了个人博客（https://kago.site），参考网友资料为博客添加了gitment作为留言板，罗列一下基本步骤，希望可以帮到大家。</summary></entry><entry><title type="html">没想到是这样的…</title><link href="https://kago.site/2017/11/19/mypets/" rel="alternate" type="text/html" title="没想到是这样的..." /><published>2017-11-19T00:00:00+08:00</published><updated>2017-11-19T00:00:00+08:00</updated><id>https://kago.site/2017/11/19/mypets</id><content type="html" xml:base="https://kago.site/2017/11/19/mypets/">&lt;h3 id=&quot;罪恶的源头&quot;&gt;罪恶的源头&lt;/h3&gt;

&lt;p&gt;一切到要从漫画家&lt;a href=&quot;http://wuhuang-wanshui.lofter.com/&quot;&gt;白茶&lt;/a&gt;养的两只“明星”说起，一只叫“吾皇”，另一只叫“巴扎黑”&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/wuhuang.jpg&quot; alt=&quot;吾皇&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/bazhahei.jpg&quot; alt=&quot;巴扎黑&quot; /&gt;&lt;/p&gt;

&lt;p&gt;只怪当时太年轻，以为集齐了吾皇和巴扎黑就能得到整个世界，然而故事好像偏离了轨道…&lt;/p&gt;

&lt;h3 id=&quot;我可能养了一只猪&quot;&gt;我可能养了一只猪&lt;/h3&gt;

&lt;p&gt;记得巴扎黑来到家里的时间大概是今年的8月15号，是女朋友送给我的，只因为我和她说过喜欢白茶养的巴扎黑。因此，我们家的小巴哥犬的名字也叫成了巴扎黑，觉得更贴切一些（其实只是因为懒）。当时这只小巴哥犬才2个月多一点，狂犬疫苗还没接种，但是阻挡不了我对它的喜爱：水汪汪的大眼睛总是像别人欠它好几块骨头似的。&lt;/p&gt;

&lt;p&gt;话不多说，直接上图：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/xiaoshihoudebazhahei.jpg&quot; alt=&quot;巴扎黑刚来的时候&quot; /&gt;&lt;/p&gt;

&lt;p&gt;巴哥犬在狗界是出了名的贪吃，加上它还是只幼犬，每天只想着吃吃吃，虽然每天都在控制食量，但还是在不到三个月的时间体重由4斤飙至11斤。粗壮的体型加上吃饭是发出的声音神似一只小猪…难怪经常被保洁阿姨唤作“你家那头小猪”。
巴扎黑，就问你羞不羞！！
&lt;img src=&quot;/images/blog/hazhaheishafa.jpg&quot; alt=&quot;胖子巴扎黑&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;我才是老大&quot;&gt;我才是老大&lt;/h3&gt;

&lt;p&gt;有了巴扎黑怎么能没有吾皇，就在一个阳光明媚的下午，一只橘猫来到的我们家。
&lt;img src=&quot;/images/blog/mao.jpg&quot; alt=&quot;蛋挞&quot; /&gt;&lt;/p&gt;

&lt;p&gt;女朋友一只想养只猫，早先养了一只美短，一个星期后送给了同事。为了这事儿她和我念叨了好多次，尤其是当巴扎黑在家里大小便的时候……&lt;/p&gt;

&lt;p&gt;蛋挞，是一只橘猫，就是最常见的家猫，以胖闻名于猫界，耳边隐约响起“十只橘猫九只胖，还有一只压塌炕”。一个星期的时间真心是见到了什么叫做能吃，肚子已经圆鼓鼓的了还在不停的找吃的。&lt;/p&gt;

&lt;p&gt;最让人抓狂的是，这个小家伙不和人亲热，一副diaodiao的样子，哎就当你是老大吧&lt;/p&gt;

&lt;h3 id=&quot;每天上演猫狗大战&quot;&gt;每天上演猫狗大战&lt;/h3&gt;

&lt;p&gt;每每想到客厅的惨状眼角就泛起了泪花，还是不写了，万一忍不住来个巴扎黑炖蛋挞呢……
&lt;img src=&quot;/images/blog/maogoudazhan.jpg&quot; alt=&quot;猫狗大战&quot; /&gt;&lt;/p&gt;</content><author><name>Barry New</name></author><summary type="html">罪恶的源头</summary></entry><entry><title type="html">mariadb的主从复制、主主复制、半同步复制的概念和方法</title><link href="https://kago.site/2017/11/19/mariadb-replicate/" rel="alternate" type="text/html" title="mariadb的主从复制、主主复制、半同步复制的概念和方法" /><published>2017-11-19T00:00:00+08:00</published><updated>2017-11-19T00:00:00+08:00</updated><id>https://kago.site/2017/11/19/mariadb-replicate</id><content type="html" xml:base="https://kago.site/2017/11/19/mariadb-replicate/">&lt;p&gt;这篇文章主要详细介绍了mariadb的主从复制、主主复制、半同步复制的概念和方法。&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;参考&lt;a href=&quot;http://www.jb51.net/article/97786.htm&quot;&gt;http://www.jb51.net/article/97786.htm&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;主从服务器的时间要同步，数据库版本最好是一致的，以免造成函数处理、日志读取、日志解析等发生异常。
以下三个主从复制的设置是独立的。
注意防火墙和selinux的影响。&lt;/p&gt;

&lt;h1 id=&quot;1简单主从复制的实现&quot;&gt;&lt;strong&gt;1、简单主从复制的实现&lt;/strong&gt;&lt;/h1&gt;

&lt;h2 id=&quot;11-服务器1操作&quot;&gt;1.1 服务器1操作&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;编辑/etc/my.cnf文件&lt;/p&gt;

    &lt;p&gt;在[mysqld]段的最后添加以下内容&lt;/p&gt;
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON    
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 1 &lt;span class=&quot;c&quot;&gt;#id号不能跟从服务器相同&lt;/span&gt;
log-bin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; master-log &lt;span class=&quot;c&quot;&gt;#自定义二进制日志文件名&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;授权可以复制本地数据库信息的主机
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service &lt;span class=&quot;c&quot;&gt;#启动mariadb server   &lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; grant replication slave,replication client on &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to &lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'10.1.51.%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; flush privileges&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;   
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show master status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#查看主服务器的状态信息，在从服务器中要用到&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
File: master-log.000003 &lt;span class=&quot;c&quot;&gt;#正在使用的二进制日志文件&lt;/span&gt;
Position: 497 &lt;span class=&quot;c&quot;&gt;#所处的位置&lt;/span&gt;
Binlog_Do_DB:
Binlog_Ignore_DB:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;12-从服务器的配置&quot;&gt;1.2 从服务器的配置&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;编辑/etc/my.cnf文件&lt;/p&gt;

    &lt;p&gt;在[mysqld]段的最后添加以下内容&lt;/p&gt;
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2 &lt;span class=&quot;c&quot;&gt;#id号不能跟主服务器相同）&lt;/span&gt;
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log &lt;span class=&quot;c&quot;&gt;#自定义二进制日志文件名）&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;设置要从哪个主服务器的那个位置开始同步
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; change master to &lt;span class=&quot;nv&quot;&gt;master_host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'10.1.51.60'&lt;/span&gt;,master_user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;,master_password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;,master_log_file&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'master-log.000003'&lt;/span&gt;,master_log_pos&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;497&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#启动复制功能&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show slave status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#查看从服务器的状态，下面显示的是部分内容&lt;/span&gt;
Master_Host: 10.1.51.60
Master_User: repluser
Master_Port: 3306
Connect_Retry: 60
Master_Log_File: master-log.000003
Read_Master_Log_Pos: 497
Relay_Log_File: slave-log.000002
Relay_Log_Pos: 530
Relay_Master_Log_File: master-log.000003
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
Master_Server_Id: 1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;13-测试&quot;&gt;1.3 测试&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;在主服务器导入事先准备好的数据库
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql &amp;lt; hellodb.sql
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在从服务器查看是否同步
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show databases&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+--------------------+
| Database   |
+--------------------+
| information_schema |
| hellodb   | &lt;span class=&quot;c&quot;&gt;#数据库已经同步&lt;/span&gt;
| mysql    |
| performance_schema |
| &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;    |
+--------------------+
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; use hellodb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; show tables&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#hellodb数据库的表也是同步的&lt;/span&gt;
+-------------------+
| Tables_in_hellodb |
+-------------------+
| classes   |
| coc    |
| courses   |
| scores   |
| students   |
| teachers   |
| toc    |
+-------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;2双主复制的实现&quot;&gt;&lt;strong&gt;2、双主复制的实现&lt;/strong&gt;&lt;/h1&gt;

&lt;h2 id=&quot;21-安装mariadb&quot;&gt;2.1 安装MariaDB&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;服务器1的操作：&lt;/li&gt;
&lt;/ul&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf文件
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;在[mysqld]段的最后添加以下内容&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 1 &lt;span class=&quot;c&quot;&gt;#id号不能跟从服务器相同&lt;/span&gt;
log-bin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; master-log &lt;span class=&quot;c&quot;&gt;#自定义主服务器的二进制日志文件名&lt;/span&gt;
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log &lt;span class=&quot;c&quot;&gt;#自定义从服务器的二进制日志文件名&lt;/span&gt;
auto_increment_offset &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 1 
auto_increment_increment &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;启动服务
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service	
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]#systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;mariadb.servic
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;服务器2的操作：&lt;/em&gt;&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf文件
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log
lob-bin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; master-log
auto_increment_offset &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2 
auto_increment_increment &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;启动服务
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service	
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]#systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;mariadb.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;22-配置双主复制&quot;&gt;2.2 配置双主复制&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;在服务器2上查看的master状态&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;说明：记录数据，在服务器2上配置时会用到。&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show master status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
File: master-log.000003
Position: 521
Binlog_Do_DB:
Binlog_Ignore_DB:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;服务器1上进行如下配置&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;说明：以下配置的内容为服务器2的IP及服务器2上查到的master数据。&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; grant replication slave,replication client on &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to &lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'192.168.1.%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; change master to &lt;span class=&quot;nv&quot;&gt;master_host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.1.188'&lt;/span&gt;,master_user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;,master_password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;,master_log_file&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'master-log.000003'&lt;/span&gt;,master_log_pos&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;521&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; SHOW SLAVE STATUS&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
              Slave_IO_State: Waiting &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;master to send event
                  Master_Host: 192.168.1.188
                  Master_User: repluser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: master-log.000003
          Read_Master_Log_Pos: 521
              Relay_Log_File: slave-log.000002
                Relay_Log_Pos: 806
        Relay_Master_Log_File: master-log.000003
            Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB:
          Replicate_Ignore_DB:
          Replicate_Do_Table:
      Replicate_Ignore_Table:
      Replicate_Wild_Do_Table:
  Replicate_Wild_Ignore_Table:
                  Last_Errno: 0
                  Last_Error:
                Skip_Counter: 0
          Exec_Master_Log_Pos: 521
              Relay_Log_Space: 1094
              Until_Condition: None
              Until_Log_File:
                Until_Log_Pos: 0
          Master_SSL_Allowed: No
          Master_SSL_CA_File:
          Master_SSL_CA_Path:
              Master_SSL_Cert:
            Master_SSL_Cipher:
              Master_SSL_Key:
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error:
              Last_SQL_Errno: 0
              Last_SQL_Error:
  Replicate_Ignore_Server_Ids:
            Master_Server_Id: 2
1 row &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.00 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;在服务器1查看master状态
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show master status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
File: master-log.000003
Position: 795
Binlog_Do_DB: 
Binlog_Ignore_DB:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;服务器2上进行如下配置&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;说明：以下的配置内容为服务器1的IP及服务器1中查到的master信息&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; grant replication slave,replication client on &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to &lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'192.168.1.%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; change master to &lt;span class=&quot;nv&quot;&gt;master_host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.1.187'&lt;/span&gt;,master_user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;,master_password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;,master_log_file&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'master-log.000003'&lt;/span&gt;,master_log_pos&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;795&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show slave status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
              Slave_IO_State: Waiting &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;master to send event
                  Master_Host: 192.168.1.187
                  Master_User: repluser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: master-log.000003
          Read_Master_Log_Pos: 795
              Relay_Log_File: slave-log.000002
                Relay_Log_Pos: 530
        Relay_Master_Log_File: master-log.000003
            Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB:
          Replicate_Ignore_DB:
          Replicate_Do_Table:
      Replicate_Ignore_Table:
      Replicate_Wild_Do_Table:
  Replicate_Wild_Ignore_Table:
                  Last_Errno: 0
                  Last_Error:
                Skip_Counter: 0
          Exec_Master_Log_Pos: 795
              Relay_Log_Space: 818
              Until_Condition: None
              Until_Log_File:
                Until_Log_Pos: 0
          Master_SSL_Allowed: No
          Master_SSL_CA_File:
          Master_SSL_CA_Path:
              Master_SSL_Cert:
            Master_SSL_Cipher:
              Master_SSL_Key:
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error:
              Last_SQL_Errno: 0
              Last_SQL_Error:
  Replicate_Ignore_Server_Ids:
            Master_Server_Id: 1
1 row &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.00 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;23-测试&quot;&gt;2.3 测试&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;在任意一台服务器上创建mydb数据库
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; create database mydb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在另一台服务器上查看
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show databases&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+--------------------+
| Database   |
+--------------------+
| information_schema |
| mydb    |
| mysql    |
| performance_schema |
| &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;    |
+--------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;3半同步复制的实现&quot;&gt;&lt;strong&gt;3、半同步复制的实现&lt;/strong&gt;&lt;/h1&gt;

&lt;h2 id=&quot;31-在主服务器上的配置&quot;&gt;3.1 在主服务器上的配置&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
 skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
 innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
 server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 1
 log-bin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; master-log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;授权可以复制本地数据库信息的主机&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service &lt;span class=&quot;c&quot;&gt;#启动mariadb server&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; grant replication slave,replication client on &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to &lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'10.1.51.%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; flush privileges&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show master status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#查看主服务器的状态信息，在从服务器中要用到&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
File: master-log.000003 &lt;span class=&quot;c&quot;&gt;#正在使用的二进制日志文件&lt;/span&gt;
Position: 245 &lt;span class=&quot;c&quot;&gt;#所处的位置&lt;/span&gt;
Binlog_Do_DB:
Binlog_Ignore_DB:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;安装rpl semi sync_master插件，并启用
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; install plugin rpl_semi_sync_master soname &lt;span class=&quot;s1&quot;&gt;'semisync_master.so'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;global rpl_semi_sync_master_enabled &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show plugins&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#可查看插件是否激活&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show global variables like &lt;span class=&quot;s1&quot;&gt;'rpl_semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#可查看安装的插件是否启用&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show global status like &lt;span class=&quot;s1&quot;&gt;'%semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#可查看从服务器的个数，此时是0个&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;32从服务器的配置&quot;&gt;3.2从服务器的配置&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf文件
在[mysqld]段的最后添加以下内容
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2 &lt;span class=&quot;c&quot;&gt;#id号不能跟主服务器相同&lt;/span&gt;
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log &lt;span class=&quot;c&quot;&gt;#自定义二进制日志文件名&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;设置要从哪个主服务器的那个位置开始同步
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service 
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql 
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; change master to &lt;span class=&quot;nv&quot;&gt;master_host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'10.1.51.60'&lt;/span&gt;,master_user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;,master_password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;,master_log_file&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'master-log.000003'&lt;/span&gt;,master_log_pos&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;245&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;安装rpl semi sync_slave插件并启用
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql 
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; install plugin rpl_semi_sync_slave soname &lt;span class=&quot;s1&quot;&gt;'semisync_slave.so'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;global rpl_semi_sync_slave_enabled &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;完成上面配置后，可以在主服务器上查看半同步复制的相关信息，命令如下：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show global status like &lt;span class=&quot;s1&quot;&gt;'%semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
Rpl_semi_sync_master_clients 1 &lt;span class=&quot;c&quot;&gt;#从服务器有一台&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;33-测试&quot;&gt;3.3 测试&lt;/h3&gt;

&lt;p&gt;测试以个人实际情况而定&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;在主服务器上导入事先准备好的数据库hellodb.sql
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt; /root/hellodb.sql&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在主服务器上查看半同步复制的状态&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; show master status&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+-------------------+----------+--------------+------------------+
| File    | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+-------------------+----------+--------------+------------------+
| master-log.000003 |  8102 |    |     |
+-------------------+----------+--------------+------------------+ 
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; show global status like &lt;span class=&quot;s1&quot;&gt;'%semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+--------------------------------------------+-------+
| Variable_name        | Value |
+--------------------------------------------+-------+
| Rpl_semi_sync_master_clients    | 1  |
| Rpl_semi_sync_master_net_avg_wait_time  | 1684 |
| Rpl_semi_sync_master_net_wait_time   | 60630 |
| Rpl_semi_sync_master_net_waits    | 36 |
| Rpl_semi_sync_master_no_times    | 1  |
| Rpl_semi_sync_master_no_tx     | 1  |
| Rpl_semi_sync_master_status    | ON |
| Rpl_semi_sync_master_timefunc_failures  | 0  |
| Rpl_semi_sync_master_tx_avg_wait_time  | 1884 |
| Rpl_semi_sync_master_tx_wait_time   | 65965 |
| Rpl_semi_sync_master_tx_waits    | 35 |
| Rpl_semi_sync_master_wait_pos_backtraverse | 0  |
| Rpl_semi_sync_master_wait_sessions   | 0  |
| Rpl_semi_sync_master_yes_tx    | 35 |
+--------------------------------------------+-------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;在从服务器上查看是否同步
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show databases&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; use hellodb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; from students&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;4-补充&quot;&gt;&lt;strong&gt;4 补充：&lt;/strong&gt;&lt;/h1&gt;

&lt;p&gt;基于上面的半同步复制配置复制的过滤器，复制过滤最好在从服务器上设置，步骤如下&lt;/p&gt;

&lt;h2 id=&quot;41-从服务器的配置&quot;&gt;4.1 从服务器的配置&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;关闭mariadb server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl stop mariadb.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf文件
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log
replicate-do-db &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; mydb &lt;span class=&quot;c&quot;&gt;#只复制mydb数据库的内容&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;补充：常用的过滤选项如下&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;Replicate_Do_DB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Ignore_DB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Do_Table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Ignore_Table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Wild_Do_Table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Wild_Ignore_Table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;重启mariadb server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;重启mariadb server后，半同步复制功能将被关闭，因此要重新启动&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show global variables like &lt;span class=&quot;s1&quot;&gt;'%semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+---------------------------------+-------+
| Variable_name     | Value |
+---------------------------------+-------+
| rpl_semi_sync_slave_enabled  | OFF |
| rpl_semi_sync_slave_trace_level | 32 |
+---------------------------------+-------+
 
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;global rpl_semi_sync_slave_enabled &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; stop slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#需先关闭从服务器复制功能再重启&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;42测试&quot;&gt;4.2测试&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;主服务器上的hellodb数据库创建一个新表semitable
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; create table semitable &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;id int&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在从服务器上查看hellodb数据库是否有semitable
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; use hellodb
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; show tables&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;（并没有）
+-------------------+
| Tables_in_hellodb |
+-------------------+
| classes   |
| coc    |
| courses   |
| scores   |
| students   |
| teachers   |
| toc    |
+-------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在主服务器上创建mydb数据库，并为其创建一个tbl1表
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; create database mydb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在从服务器上查看mydb数据库的是否有tbl1表
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; use mydb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;mydb]&amp;gt; show tables&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; （可以查看到）
+----------------+
| Tables_in_mydb |
+----------------+
| tbl1   |
+----------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;</content><author><name>Barry New</name></author><summary type="html">这篇文章主要详细介绍了mariadb的主从复制、主主复制、半同步复制的概念和方法。 参考http://www.jb51.net/article/97786.htm</summary></entry><entry><title type="html">初尝</title><link href="https://kago.site/2017/11/17/first-blog/" rel="alternate" type="text/html" title="初尝" /><published>2017-11-17T00:00:00+08:00</published><updated>2017-11-17T00:00:00+08:00</updated><id>https://kago.site/2017/11/17/first-blog</id><content type="html" xml:base="https://kago.site/2017/11/17/first-blog/">&lt;h2 id=&quot;我是标题&quot;&gt;我是标题&lt;/h2&gt;

&lt;p&gt;我是正文~&lt;/p&gt;</content><author><name>Barry New</name></author><summary type="html">我是标题</summary></entry></feed>