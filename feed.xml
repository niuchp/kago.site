<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.7.4">Jekyll</generator><link href="https://kago.site/feed.xml" rel="self" type="application/atom+xml" /><link href="https://kago.site/" rel="alternate" type="text/html" /><updated>2018-11-26T20:17:26+08:00</updated><id>https://kago.site/feed.xml</id><title type="html">阅后即忘 | 牛昌平的个人博客</title><subtitle>点滴积累，聚沙成塔</subtitle><author><name>Barry New</name></author><entry><title type="html">CentOS7安装rancher2.x</title><link href="https://kago.site/2018/11/26/install-rancher/" rel="alternate" type="text/html" title="CentOS7安装rancher2.x" /><published>2018-11-26T00:00:00+08:00</published><updated>2018-11-26T00:00:00+08:00</updated><id>https://kago.site/2018/11/26/install-rancher</id><content type="html" xml:base="https://kago.site/2018/11/26/install-rancher/">&lt;h1 id=&quot;centos7安装rancher2x&quot;&gt;CentOS7安装Rancher2.x&lt;/h1&gt;

&lt;p&gt;容器已然成为IT建设的潮流，目前最流行的容器管理、编排方案莫过于Kubernetes（简称K8S)，但是使用过K8S的小伙伴肯定和我一样爬坑无数。我曾经写过一套安装脚本用于公司内部环境部署，虽所简化了安装过程，但在管理多个K8S环境时（项目多数以整个集群为交付成果，开发测试时也划分了多个集群）仍然很犯难，Rancher对我而言最大的吸引点可能就在于此吧，参考官方文档实验后简单记录如下，便于日后回顾。&lt;/p&gt;

&lt;h2 id=&quot;1rancher简介&quot;&gt;1、Rancher简介&lt;/h2&gt;

&lt;p&gt;Rancher是一套容器管理平台，它可以帮助组织在生产环境中轻松快捷的部署和管理容器。 Rancher可以轻松地管理各种环境的Kubernetes，满足IT需求并为DevOps团队提供支持。&lt;/p&gt;

&lt;p&gt;Kubernetes不仅已经成为的容器编排标准，它也正在迅速成为各类云和虚拟化厂商提供的标准基础架构。Rancher用户可以选择使用Rancher Kubernetes Engine(RKE)创建Kubernetes集群，也可以使用GKE，AKS和EKS等云Kubernetes服务。 Rancher用户还可以导入和管理现有的Kubernetes集群。&lt;/p&gt;

&lt;p&gt;Rancher支持各类集中式身份验证系统来管理Kubernetes集群。例如，大型企业的员工可以使用其公司Active Directory凭证访问GKE中的Kubernetes集群。IT管​​理员可以在用户，组，项目，集群和云中设置访问控制和安全策略。 IT管​​理员可以在单个页面对所有Kubernetes集群的健康状况和容量进行监控。&lt;/p&gt;

&lt;p&gt;(引自&lt;a href=&quot;https://www.cnrancher.com/docs/rancher/v2.x/cn/overview/&quot;&gt;Rancher Labs&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/rancher/rancher-architecture.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;2组件版本&quot;&gt;2、组件版本&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;操作系统：CentOS7.2&lt;/li&gt;
  &lt;li&gt;OS内核：3.10.0 (使用Overlay2需要升级内核至4.x）&lt;/li&gt;
  &lt;li&gt;Rancher:2.1.1&lt;/li&gt;
  &lt;li&gt;Docker: 17.03&lt;/li&gt;
  &lt;li&gt;集群IP地址划分：&lt;/li&gt;
&lt;/ul&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;role&lt;/th&gt;
      &lt;th&gt;hostname&lt;/th&gt;
      &lt;th&gt;IP&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;rancher-server&lt;/td&gt;
      &lt;td&gt;server&lt;/td&gt;
      &lt;td&gt;192.168.31.10&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;worker&lt;/td&gt;
      &lt;td&gt;node1&lt;/td&gt;
      &lt;td&gt;192.168.31.11&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;worker&lt;/td&gt;
      &lt;td&gt;node2&lt;/td&gt;
      &lt;td&gt;192.168.31.12&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;worker&lt;/td&gt;
      &lt;td&gt;node3&lt;/td&gt;
      &lt;td&gt;192.168.31.13&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;registry&lt;/td&gt;
      &lt;td&gt;harbor.kago.site&lt;/td&gt;
      &lt;td&gt;192.168.31.65&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;3基础环境安装&quot;&gt;3、基础环境安装&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;1.  操作系统安装&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;推荐使用“minimal install”最小安装模式，安装完毕后再按需安装“vim、ip-utils、net-tools”等工具。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;2.  配置主机名&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;命令：hostnamectl set-hostname &amp;lt;hostname&amp;gt;&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;因为K8S的规定，主机名只支持包含 - 和 .(中横线和点)两种特殊符号，并且主机名不能出现重复。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;3. 关闭防火墙、selinux&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;4. kernel性能优化&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /etc/sysctl.conf&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-iptables=1
net.ipv4.neigh.default.gc_thresh1=4096
net.ipv4.neigh.default.gc_thresh2=6144
net.ipv4.neigh.default.gc_thresh3=8192
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;4安装docker&quot;&gt;4、安装docker&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;1. 修改YUM源&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;cp /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/yum.repos.d/CentOS-Base.repo &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;

[base]
name=CentOS-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; - Base - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/os/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/os/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.cloud.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/os/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
gpgcheck=1
gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7

#released updates
[updates]
name=CentOS-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; - Updates - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/updates/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/updates/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.cloud.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/updates/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
gpgcheck=1
gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7

#additional packages that may be useful
[extras]
name=CentOS-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; - Extras - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/extras/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/extras/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.cloud.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/extras/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
gpgcheck=1
gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7

#additional packages that extend functionality of existing packages
[centosplus]
name=CentOS-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; - Plus - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/centosplus/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/centosplus/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.cloud.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/centosplus/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
gpgcheck=1
enabled=0
gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7

#contrib - packages by Centos Users
[contrib]
name=CentOS-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; - Contrib - mirrors.aliyun.com
failovermethod=priority
baseurl=http://mirrors.aliyun.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/contrib/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/contrib/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
        http://mirrors.cloud.aliyuncs.com/centos/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$releasever&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/contrib/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$basearch&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;/
gpgcheck=1
enabled=0
gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;
EOF
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;2. 安装Docker-ce&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;因为CentOS的安全限制，通过RKE安装K8S集群时候无法使用root账户。所以，建议CentOS用户使用非root用户来运行docker,不管是RKE还是custom安装k8s。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 添加用户（可选）&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;adduser &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&amp;lt;new_user&amp;gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 为新用户设置密码&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;passwd &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&amp;lt;new_user&amp;gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 为新用户添加sudo权限&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&amp;lt;new_user&amp;gt; ALL=(ALL) ALL'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /etc/sudoers
&lt;span class=&quot;c&quot;&gt;# 卸载旧版本Docker软件&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;yum remove docker &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              docker-client &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              docker-client-latest &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              docker-common &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              docker-latest &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              docker-latest-logrotate &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              docker-logrotate &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              docker-selinux &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              docker-engine-selinux &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              docker-engine &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
              container&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 定义安装版本&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;docker_version&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;17.03.2
&lt;span class=&quot;c&quot;&gt;# step 1: 安装必要的一些系统工具&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;yum update &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;yum install &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; yum-utils device-mapper-persistent-data lvm2 bash-completion
&lt;span class=&quot;c&quot;&gt;# Step 2: 添加软件源信息&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;yum-config-manager &lt;span class=&quot;nt&quot;&gt;--add-repo&lt;/span&gt; http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
&lt;span class=&quot;c&quot;&gt;# Step 3: 更新并安装 Docker-CE&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;yum makecache all
&lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;yum list docker-ce.x86_64 &lt;span class=&quot;nt&quot;&gt;--showduplicates&lt;/span&gt; | sort &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt;|grep &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;docker_version&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;|awk &lt;span class=&quot;s1&quot;&gt;'{print $2}'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install &lt;span class=&quot;nt&quot;&gt;--setopt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;obsoletes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0 docker-ce-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; docker-ce-selinux-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 如果已经安装高版本Docker,可进行降级安装(可选)&lt;/span&gt;
yum downgrade &lt;span class=&quot;nt&quot;&gt;--setopt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;obsoletes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0 &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; docker-ce-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; docker-ce-selinux-&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 把当前用户加入docker组&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;usermod &lt;span class=&quot;nt&quot;&gt;-aG&lt;/span&gt; docker &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&amp;lt;new_user&amp;gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 设置开机启动&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;docker
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;Docker-Engine Docker官方已经不推荐使用，请安装Docker-CE。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;3. 配置Docker&lt;/strong&gt;
daemon.json默认位于/etc/docker/daemon.json，如果没有可手动创建，基于systemd管理的系统都是相同的路径。通过修改daemon.json来改过Docker配置，也是Docker官方推荐的方法。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@server ~]# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/docker/daemon.json
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;registry-mirrors&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://8m0vweth.mirror.aliyuncs.com&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
&lt;span class=&quot;s2&quot;&gt;&quot;insecure-registries&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0.0.0.0/0&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;4. 配置Docker存储驱动&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;本次实验跳过此步骤&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;OverlayFS是一个新一代的联合文件系统，类似于AUFS，但速度更快，实现更简单。Docker为OverlayFS提供了两个存储驱动程序:旧版的overlay，新版的overlay2(更稳定)。&lt;/p&gt;

&lt;p&gt;先决条件：&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;overlay2: Linux内核版本4.0或更高版本，或使用内核版本3.10.0-514+的RHEL或CentOS。&lt;/li&gt;
  &lt;li&gt;overlay: 主机Linux内核版本3.18+&lt;/li&gt;
  &lt;li&gt;支持的磁盘文件系统
    &lt;ul&gt;
      &lt;li&gt;ext4(仅限RHEL 7.1)&lt;/li&gt;
      &lt;li&gt;xfs(RHEL7.2及更高版本)，需要启用d_type=true。 &amp;gt;具体详情参考 Docker Use the OverlayFS storage driver&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;编辑/etc/docker/daemon.json加入以下内容&lt;/p&gt;
&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;storage-driver&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;overlay2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;storage-opts&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;overlay2.override_kernel_check=true&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;5. 配置日志驱动&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;容器在运行时会产生大量日志文件，很容易占满磁盘空间。通过配置日志驱动来限制文件大小与文件的数量。 &amp;gt;限制单个日志文件为100M,最多产生3个日志文件&lt;/p&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;log-driver&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;json-file&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;log-opts&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;max-size&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;100m&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;max-file&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;5harbor镜像库安装&quot;&gt;5、harbor镜像库安装&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;安装harbor是用于离线安装rancher组件、K8S组件时的镜像拉取，也可以用于应用部署时自定义镜像存储&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Harbor 是一个企业级的 Docker Registry，可以实现images的私有存储和日志统计权限控制等功能，并支持创建多项目(Harbor 提出的概念)，基于官方Registry实现。 通过地址:&lt;a href=&quot;https://github.com/goharbor/harbor/releases/&quot;&gt;https://github.com/goharbor/harbor/releases/&lt;/a&gt;可以下载最新的版本。官方提供了三种版本:在线版、离线版、OVA虚拟镜像版。&lt;/p&gt;

&lt;p&gt;在线安装:安装程序从Docker镜像仓库下载Harbour相关映像。因此，安装程序的尺寸非常小。
离线安装:主机没有Internet连接时使用此安装程序镜像安装。安装程序包含所有镜像，因此压缩包较大。
详细过程参考&lt;a href=&quot;https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md&quot;&gt;harbor安装&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;1. 配置https&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;1.1  生成自建ca 证书
默认在/data/cert/&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[root@harbor ~]#cd /data/cert/
[root@harbor cert]#openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt -subj &quot;/CN=kago.site&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;1.2  生成请求&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@harbor cert]#openssl req &lt;span class=&quot;nt&quot;&gt;-newkey&lt;/span&gt; rsa:4096 &lt;span class=&quot;nt&quot;&gt;-nodes&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sha256&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-keyout&lt;/span&gt; harbor.kago.site.key &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; harbor.kago.site.csr &lt;span class=&quot;nt&quot;&gt;-subj&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/CN=harbor.kago.site&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;1.3 证书签署&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@harbor cert]#openssl x509 &lt;span class=&quot;nt&quot;&gt;-req&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-days&lt;/span&gt; 365 &lt;span class=&quot;nt&quot;&gt;-in&lt;/span&gt; harbor.kago.site.csr &lt;span class=&quot;nt&quot;&gt;-CA&lt;/span&gt; ca.crt &lt;span class=&quot;nt&quot;&gt;-CAkey&lt;/span&gt; ca.key &lt;span class=&quot;nt&quot;&gt;-CAcreateserial&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; harbor.kago.site.crt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;1.4 更改配置&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[root@harbor harbor]#vim harbor.cfg
hostname = harbor.kago.site:443
ui_url_protocol = https
ssl_cert = /data/cert/harbor.kago.site.crt
ssl_cert_key = /data/cert/harbor.kago.site.key
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;2. 执行安装&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@harbor cert]#cd /opt/harbor/
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@harbor harbor]#sh install.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;6离线环境镜像准备&quot;&gt;6、离线环境镜像准备&lt;/h2&gt;
&lt;p&gt;在线安装rancher虽然方便，但需要从互联网拉取诸多镜像，在独立内网环境下不适用，此处记录离线环境下安装rancher。
在联网环境下获取镜像后，以便离线使用&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;所需镜像列表&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@harbor opt]#cat rancher-images.txt
busybox
minio/minio:RELEASE.2018-05-25T19-49-13Z
rancher/alertmanager-helper:v0.0.2
rancher/calico-cni:v3.1.1
rancher/calico-cni:v3.1.3
rancher/calico-ctl:v2.0.0
rancher/calico-node:v3.1.1
rancher/calico-node:v3.1.3
rancher/cluster-proportional-autoscaler-amd64:1.0.0
rancher/coreos-etcd:v3.1.12
rancher/coreos-etcd:v3.2.18
rancher/coreos-etcd:v3.2.24
rancher/coreos-flannel-cni:v0.2.0
rancher/coreos-flannel-cni:v0.3.0
rancher/coreos-flannel:v0.10.0
rancher/coreos-flannel:v0.9.1
rancher/docker-elasticsearch-kubernetes:5.6.2
rancher/fluentd-helper:v0.1.2
rancher/fluentd:v0.1.10
rancher/hyperkube:v1.10.5-rancher1
rancher/hyperkube:v1.11.3-rancher1
rancher/hyperkube:v1.12.0-rancher1
rancher/hyperkube:v1.9.7-rancher2
rancher/jenkins-jnlp-slave:3.10-1-alpine
rancher/jenkins-plugins-docker:17.12
rancher/k8s-dns-dnsmasq-nanny-amd64:1.14.10
rancher/k8s-dns-dnsmasq-nanny-amd64:1.14.13
rancher/k8s-dns-dnsmasq-nanny-amd64:1.14.7
rancher/k8s-dns-dnsmasq-nanny-amd64:1.14.8
rancher/k8s-dns-kube-dns-amd64:1.14.10
rancher/k8s-dns-kube-dns-amd64:1.14.13
rancher/k8s-dns-kube-dns-amd64:1.14.7
rancher/k8s-dns-kube-dns-amd64:1.14.8
rancher/k8s-dns-sidecar-amd64:1.14.10
rancher/k8s-dns-sidecar-amd64:1.14.13
rancher/k8s-dns-sidecar-amd64:1.14.7
rancher/k8s-dns-sidecar-amd64:1.14.8
rancher/kibana:5.6.4
rancher/log-aggregator:v0.1.3
rancher/metrics-server-amd64:v0.2.1
rancher/metrics-server-amd64:v0.3.1
rancher/nginx-ingress-controller-defaultbackend:1.4
rancher/nginx-ingress-controller:0.16.2-rancher1
rancher/pause-amd64:3.0
rancher/pause-amd64:3.1
rancher/pipeline-jenkins-server:v0.1.0
rancher/pipeline-tools:v0.1.0
rancher/prom-alertmanager:v0.15.2
rancher/rke-tools:v0.1.13
rancher/rke-tools:v0.1.15
registry:2
rancher/rancher:v2.1.1
rancher/rancher-agent:v2.1.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;拉取保存脚本&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@harbor opt]#cat rancher-save-images.sh
&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;rancher-images.txt&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;images&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;rancher-images.tar.gz&quot;&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;POSITIONAL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=()&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$# &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-gt&lt;/span&gt; 0 &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
    &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$key&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--images&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;images&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$2&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;shift&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# past argument&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;shift&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# past value&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--image-list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$2&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;shift&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# past argument&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;shift&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# past value&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--help&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;help&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;shift&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;esac&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done

&lt;/span&gt;usage &lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;USAGE: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$0&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; [--image-list rancher-images.txt] [--images rancher-images.tar.gz]&quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;  [-l|--images-list path] text file with list of images. 1 per line.&quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;  [-l|--images path] tar.gz generated by docker save.&quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;  [-h|--help] Usage message&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$help&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
    &lt;/span&gt;usage
    &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;0
&lt;span class=&quot;k&quot;&gt;fi

&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;i &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
    &lt;/span&gt;docker pull &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done

&lt;/span&gt;docker save &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; | tr &lt;span class=&quot;s1&quot;&gt;'\n'&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;' '&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt; | gzip &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;images&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;项目创建&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;登录harbor.kago.site，创建公开项目rancher、minio&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;镜像上传&lt;br /&gt;
```bash
[root@harbor opt]#cat rancher-load-images.sh
#!/bin/bash
list=”rancher-images.txt”
images=”rancher-images.tar.gz”&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;POSITIONAL=()
while [[ $# -gt 0 ]]; do
    key=”$1”
    case $key in
        -r|–registry)
        reg=”$2”
        shift # past argument
        shift # past value
        ;;
        -l|–image-list)
        list=”$2”
        shift # past argument
        shift # past value
        ;;
        -i|–images)
        images=”$2”
        shift # past argument
        shift # past value
        ;;
        -h|–help)
        help=”true”
        shift
        ;;
    esac
done&lt;/p&gt;

&lt;p&gt;usage () {
    echo “USAGE: $0 [–image-list rancher-images.txt] [–images rancher-images.tar.gz] –registry my.registry.com:5000”
    echo “  [-l|–images-list path] text file with list of images. 1 per line.”
    echo “  [-l|–images path] tar.gz generated by docker save.”
    echo “  [-r|–registry registry:port] target private registry:port.”
    echo “  [-h|–help] Usage message”
}&lt;/p&gt;

&lt;p&gt;if [[ -z $reg ]]; then
    usage
    exit 1
fi
if [[ $help ]]; then
    usage
    exit 0
fi&lt;/p&gt;

&lt;p&gt;set -e -x&lt;/p&gt;

&lt;p&gt;docker load –input ${images}&lt;/p&gt;

&lt;p&gt;for i in $(cat ${list}); do
    docker tag ${i} ${reg}/${i}
    docker push ${reg}/${i}
done&lt;/p&gt;

&lt;p&gt;[root@harbor opt]#docker login harbor.kago.site
[root@harbor opt]#sh rancher-load-images.sh -l ./rancher-images.txt -r harbor.kago.site&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;


## 7、安装rancher-server
1. 启动rancher-server   
```bash
[root@server opt]#docker run -d --restart=unless-stopped   -p 80:80 -p 443:443   -v /root/var/log/auditlog:/var/log/auditlog   -e AUDIT_LEVEL=3   -e AUDIT_LOG_PATH=/var/log/auditlog/rancher-api-audit.log   -e AUDIT_LOG_MAXAGE=20   -e AUDIT_LOG_MAXBACKUP=20   -e AUDIT_LOG_MAXSIZE=100   harbor.kago.site/rancher/rancher:v2.1.1
[root@server ~]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                                      NAMES
8dc861f595b4        5370bbde1a1b        &quot;entrypoint.sh&quot;     7 hours ago         Up 6 hours          0.0.0.0:80-&amp;gt;80/tcp, 0.0.0.0:443-&amp;gt;443/tcp   stupefied_austin
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;浏览器登录rancher-server
    &lt;ul&gt;
      &lt;li&gt;设置密码&lt;/li&gt;
      &lt;li&gt;设置url
        &lt;blockquote&gt;
          &lt;p&gt;重置管理员密码：docker exec -ti &lt;container_id&gt; reset-password&lt;/container_id&gt;&lt;/p&gt;
        &lt;/blockquote&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;8k8s集群安装&quot;&gt;8、K8S集群安装&lt;/h2&gt;
&lt;ol&gt;
  &lt;li&gt;修改系统镜像库地址&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;使用浏览器登录rancher-server，点击“全局配置”–“系统设置”，找到“system-default-registry”，点击编辑，设置为harbor镜像库地址。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/rancher/2018-11-26_112843.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/rancher/2018-11-26_112911.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;添加集群 &lt;br /&gt;
&lt;img src=&quot;/images/posts/rancher/2018-11-26_112242.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;选择自定义 &lt;br /&gt;
&lt;img src=&quot;/images/posts/rancher/2018-11-26_112436.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;选择组件信息&lt;br /&gt;
&lt;img src=&quot;/images/posts/rancher/2018-11-26_112549.png&quot; alt=&quot;&quot; /&gt;
    &lt;blockquote&gt;
      &lt;p&gt;当有内外网时，点击“高级选型”添加主机内外网地址&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;选择主机角色 &lt;br /&gt;
&lt;img src=&quot;/images/posts/rancher/2018-11-26_112702.png&quot; alt=&quot;&quot; /&gt;
    &lt;blockquote&gt;
      &lt;p&gt;主机角色中的etcd为k8s中数据库，controller包含k8s的master组件（apiserver、controller manager、schedule），worker包含kubelet、kube-proxy&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;登录主机执行命令 &lt;br /&gt;
拷贝给出的命令，登录目标主机执行命令，片刻后会自动注册至rancher-server&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;注册成功 &lt;br /&gt;
&lt;img src=&quot;/images/posts/rancher/2018-11-26_113449.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;9命令行工具&quot;&gt;9、命令行工具&lt;/h2&gt;
&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;kubectl &lt;br /&gt;
点击“集群”，点击“kubeconfig”复制文件到需要运行kubectl的主机~/.kube/config&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;rancher-cli &lt;br /&gt;
登录rancher-server，点击用户头像，选择“api&amp;amp;ksys”，点击添加key，填写描述信息，选择有效时长，保存key信息，复制token
在安装有rancher-cli的windows cmd中运行： &lt;br /&gt;
rancher login https://rancher-server-ip  –token &amp;lt;token&amp;gt;
&lt;img src=&quot;/images/posts/rancher/2018-11-26_133849.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;</content><author><name>Barry New</name></author><summary type="html">CentOS7安装Rancher2.x</summary></entry><entry><title type="html">Linux下安装tomcat</title><link href="https://kago.site/2018/11/15/tomcat-install/" rel="alternate" type="text/html" title="Linux下安装tomcat" /><published>2018-11-15T00:00:00+08:00</published><updated>2018-11-15T00:00:00+08:00</updated><id>https://kago.site/2018/11/15/tomcat-install</id><content type="html" xml:base="https://kago.site/2018/11/15/tomcat-install/">&lt;h1 id=&quot;前言&quot;&gt;前言&lt;/h1&gt;

&lt;p&gt;tomcat 是一款优秀的 web 应用服务器，可以用来运行 servlet。下文记录 tomcat 的安装以及使用 systemctl 命令进行控制的过程。&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;systemctl命令是service和chkconfig命令的集合 service命令:用于启动、停止、重新启动和关闭系统服务，还可以显示所有系统服务的当前状态 chkconfig命令:用于更新（启动或停止）和查询系统服务的运行级信息&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;1安装tomcat&quot;&gt;1、安装tomcat&lt;/h2&gt;

&lt;h3 id=&quot;11下载二进制文件&quot;&gt;1.1、下载二进制文件&lt;/h3&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# wget http://mirrors.hust.edu.cn/apache/tomcat/tomcat-9/v9.0.13/bin/apache-tomcat-9.0.13.tar.gz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;12解压文件&quot;&gt;1.2、解压文件&lt;/h3&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# &lt;span class=&quot;nb&quot;&gt;tar&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-zxf&lt;/span&gt; apache-tomcat-9.0.13.tar.gz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;13移动文件到opt下&quot;&gt;1.3、移动文件到/opt下&lt;/h3&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# mv  apache-tomcat-9.0.13 /opt/apache-tomcat-9.0.13/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;14创建软链&quot;&gt;1.4、创建软链&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master opt]# ln &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; /opt/apache-tomcat-9.0.13  /usr/local/tomcat
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;15配置jdk环境变量&quot;&gt;1.5、配置jdk环境变量&lt;/h3&gt;

&lt;p&gt;添加：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;JAVA_HOME=/usr/java/default
JRE_HOME=$JAVA_HOME/jre
PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin
CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib
export JAVA_HOME PATH CLASSPATH
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;16生效环境变量&quot;&gt;1.6、生效环境变量&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master opt]# &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt; /etc/profile
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;17配置tomcat端口默认8080&quot;&gt;1.7、配置tomcat端口（默认8080）&lt;/h3&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# vim /usr/local/tomcat/conf/server.xml
&lt;span class=&quot;c&quot;&gt;#修改：&lt;/span&gt;
 &amp;lt;Connector &lt;span class=&quot;nv&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;8080&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;protocol&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;HTTP/1.1&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;18启动tomcat&quot;&gt;1.8、启动tomcat&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# /usr/local/tomcat/bin/startup.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;19验证&quot;&gt;1.9、验证&lt;/h3&gt;
&lt;p&gt;浏览器输入：http://IP:PROT&lt;/p&gt;

&lt;h2 id=&quot;2配置systemctl&quot;&gt;2、配置systemctl&lt;/h2&gt;

&lt;h3 id=&quot;21新建tomcatpid&quot;&gt;2.1、新建tomcat.pid&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /usr/local/tomcat-9.0.13
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master tomcat-9.0.13]# touch tomcat.pid
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;22新建setenvshcatalinash调用&quot;&gt;2.2、新建setenv.sh(catalina.sh调用）&lt;/h3&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master tomcat-9.0.13]# &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;bin
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master bin]# vim setenv.sh

&lt;span class=&quot;c&quot;&gt;#$CATALINA_BASE为tomcat安装的目录路径,将tomcat.pid指给了CATALINA_PID&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CATALINA_PID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CATALINA_BASE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/tomcat.pid&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#设置tomcat启动的java内存参数&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;JAVA_OPTS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;-server -XX:PermSize=256M -XX:MaxPermSize=1024m -Xms512M -Xmx1024M -XX:MaxNewSize=256m&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;23创建service文件&quot;&gt;2.3、创建service文件&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master bin]# vim /usr/lib/systemd/system/tomcat.service

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Tomcat
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;syslog.target network.target remote-fs.target nss-lookup.target
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;forking
&lt;span class=&quot;nv&quot;&gt;PIDFile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/tomcat-9.0.13/tomcat.pid
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/tomcat-9.0.13/bin/startup.sh
&lt;span class=&quot;nv&quot;&gt;ExecReload&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; HUP &lt;span class=&quot;nv&quot;&gt;$MAINPID&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ExecStop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/bin/kill &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; QUIT &lt;span class=&quot;nv&quot;&gt;$MAINPID&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;PrivateTmp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;24测试&quot;&gt;2.4、测试&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master bin]# systemctl start tomcat.service
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master bin]# systemctl status tomcat.service
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master bin]# systemctl stop tomcat.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Barry New</name></author><summary type="html">前言</summary></entry><entry><title type="html">最美青海六日行</title><link href="https://kago.site/2018/05/08/%E9%9D%92%E6%B5%B76%E6%97%A5%E8%A1%8C/" rel="alternate" type="text/html" title="最美青海六日行" /><published>2018-05-08T00:00:00+08:00</published><updated>2018-05-08T00:00:00+08:00</updated><id>https://kago.site/2018/05/08/%E9%9D%92%E6%B5%B76%E6%97%A5%E8%A1%8C</id><content type="html" xml:base="https://kago.site/2018/05/08/%E9%9D%92%E6%B5%B76%E6%97%A5%E8%A1%8C/">&lt;blockquote&gt;
  &lt;center&gt; 
巍巍昆仑山脚下,
&lt;/center&gt;
&lt;/blockquote&gt;

&lt;p&gt;是我心中最美的家,&lt;/p&gt;

&lt;p&gt;千山万水曾走过脚下,&lt;/p&gt;

&lt;p&gt;始终眷恋深爱着她,&lt;/p&gt;

&lt;p&gt;碧波荡漾的青海湖,&lt;/p&gt;

&lt;p&gt;胜似一幅美丽的画,&lt;/p&gt;

&lt;p&gt;香气怡人的郁金香,&lt;/p&gt;

&lt;p&gt;朵朵绽放阳光下,&lt;/p&gt;

&lt;p&gt;遥望山间的群群白羊,&lt;/p&gt;

&lt;p&gt;像白云游走山脚下,&lt;/p&gt;

&lt;p&gt;片片翠绿的青稞粮,&lt;/p&gt;

&lt;p&gt;酿出美酒饮天下,&lt;/p&gt;

&lt;p&gt;聆听嘹亮的青海花儿,&lt;/p&gt;

&lt;p&gt;唱出心中幸福的话,&lt;/p&gt;

&lt;p&gt;神圣庄严的塔尔寺,&lt;/p&gt;

&lt;p&gt;播撒福祉传天下,&lt;/p&gt;

&lt;p&gt;无论我走到海角天涯,&lt;/p&gt;

&lt;p&gt;最爱青海我的家,&lt;/p&gt;

&lt;p&gt;清澈甘甜古老的三江源,&lt;/p&gt;

&lt;p&gt;默默地哺育我长大,&lt;/p&gt;

&lt;p&gt;无论我走到海角天涯,&lt;/p&gt;

&lt;p&gt;最爱青海我的家,&lt;/p&gt;

&lt;p&gt;勤劳善良纯朴的青海人,&lt;/p&gt;

&lt;p&gt;等你做客我的家,&lt;/p&gt;

&lt;p&gt;…&lt;br /&gt;
&amp;lt;/center &amp;gt;&lt;/p&gt;

&lt;p&gt;一首《最爱青海》，嘤嘤绕耳，一幅幅美丽的画卷，缓缓浮现，仿佛又把我带回了令人心旷神怡的地方，高山、白雪、美人、美画……&lt;br /&gt;
可能提起青海，印象中的是 “暮雪连青海，阴霞覆白山。可怜班定远，生入玉门关。”、“青海长云暗雪山，孤城遥望玉门关。黄沙百战穿金甲，不破楼兰终不还。”、或者是拥有中国最大内陆咸水湖–青海湖,再者是那个位于青藏高原不包邮的 “荒凉” 省份。而我更多的可能是 “青海烩面” 这四个字（原谅喜欢面食的我~~）。依稀记得大学二年级的时候舍友小胖提议说要去青海，去西宁，去看看美丽的青海湖，去鸟岛转一转，那时候我对青海着实不了解，甚至不赞成他去西部那么偏脊的地方，现在想想，那时候还真是“天真无邪”。&lt;/p&gt;

&lt;p&gt;青海，像是一个披着青纱的女子，远望而去，只见其表，泯于众人；拂纱近观，窥其真貌，方显婀娜曼妙。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt;前夕 |惊·险&lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;此次青海之行大约是在三月底就开始计划，当然策划这场完美行程的人并不是我，“嗯嗯，好的”、“我都可以”、“多少钱，微信转给你啊”这才是我，偷懒一次，坐享其成~&lt;/p&gt;

&lt;p&gt;原定行程是请假 2 天和五·一假期拼成 5 日环游，通过微博联系到另外两位来自厦门的小姐姐一起包商务车，走青海大环线，三方会谈，行程有异，再请假，改签，补钱。&lt;/p&gt;

&lt;p&gt;原以为一行人可以顺利汇合，谁成想小姐姐们遭遇“生死时速”赶火车，半小时后就在大家为小姐姐赶上火车庆幸的时候，小姐姐周围杀出了程咬金，还是两位，7 个人，超员（微笑脸），临时调整队伍、重新分配车辆、联系司机、确定行程、约定接送时间地点，搞完这些也到了登机时间（当听到对方可能赶不上火车并且失联了半小时，某位傻子一度担心这是个圈套，可能会被临时加价敲诈，笑出猪叫声~~~），在困意与激动的斗争中顺利抵达青海西宁，坐标：海东市曹家堡机场。&lt;/p&gt;

&lt;p&gt;青海我们来了。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt;Day1 | 佛塔·雪山·青海湖&lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;4月27日&lt;br /&gt;
行程：西宁→塔尔寺→拉脊山旅游公路→日月山→倒淌河→青海湖→黑马河(宿)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;center&gt;◇ 佛塔 ◇&lt;/center&gt;

&lt;p&gt;藏传佛教，在我心中一直笼罩着神秘的面纱，《冈仁波齐》的朝圣之路，三步一磕等身长头的转山，转经筒、转经轮，袅袅藏香，随风浮动的经幡，在这特定的环境下，感受着这特殊的仪式，让人不由的心生敬畏，仿佛有双贯穿一切的眼眸通体审视着自己，让罪恶、杂念化为乌有，心似头顶的蓝天白云，清澈透底，藏不得半点污秽。&lt;/p&gt;

&lt;p&gt;塔尔寺于青海，如同布达拉宫之于西藏，是青海人心中的圣地，也是一所传授、研究藏传佛学的著名佛学院。在塔尔寺漫步期间，见到无数位佝偻老者，在白塔前、佛像前磕等身长头，肉体的束缚，并不能抵挡礼佛的虔诚。看着殿前对面、门口两侧低下的砖石被信徒磨出深深的痕迹，我不知道是什么样的力量让他们可以抛弃对物质、对肉体的欲望，食简餐、饮清水、裹素衣，沉浸在精神世界里的大追求、大满足。&lt;/p&gt;

&lt;p&gt;&lt;em&gt;&lt;center&gt;&amp;lt;font size=2&amp;gt;“八宝如意塔，位于寺前广场。据说，这八个塔是为纪念佛祖释迦牟尼一生之中的八大功德而建造的，建于1776年。其造型大同小异，塔身高6.4米，塔底周长9.4米，底座面积5.7平方米。塔身白灰抹面，底座青砖砌成，腰部装饰有经文，每个塔身南面还有一个佛龛，里面藏有梵文。从东向西依次是：莲聚塔、四谛塔、息诤塔、菩提塔、神变塔、降凡塔、胜利塔、涅塔。纪念的不是世尊的功德，是世尊的一生八大重要德行，所以又叫善逝八塔”&amp;lt;/font&amp;gt;&lt;/center&gt;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/taersi.jpg&quot; alt=&quot;塔尔寺&quot; /&gt;&lt;/p&gt;
&lt;center&gt;八宝如意塔&lt;/center&gt;

&lt;center&gt;◇ 雪山 ◇&lt;/center&gt;

&lt;p&gt;怀着复杂的心情前往下一站青海湖，途中经过一座身披圣洁白衣的拉脊山。拉脊山长约 260 公里，山峰海拔多在 4000~4500 之间，此次途径，恰逢山顶白雪未融，巍峨山脉像是一条条洁白巨龙盘卧在天地之间，由深色天空、白色雪顶、土黄色大地组成的画面里，我们仿佛一粒砂石那样的渺小，那样的微不足道，此情此景带来的震撼恐怕只有身在其中才能感受的到。&lt;/p&gt;

&lt;p&gt;&lt;em&gt;&lt;center&gt;“由于拉脊山海拔较高，温度低（海拔每升高 1000 米，气温平均下降 6 ℃），4月的拉脊山顶依然白雪皑皑，山脚下的依然是枯草连片，只待春风拂过，生机再现。”&lt;/center&gt;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/lajishanyuanjing.jpg&quot; alt=&quot;拉脊山远景&quot; /&gt;&lt;/p&gt;
&lt;center&gt;触手可及的雪山&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/lajishandi.jpg&quot; alt=&quot;雪山下的姑娘&quot; /&gt;&lt;/p&gt;
&lt;center&gt;雪山下的姑娘&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/lajishantiaoyue.jpg&quot; alt=&quot;雪中的精灵&quot; /&gt;&lt;/p&gt;
&lt;center&gt;雪中跳跃的精灵&lt;/center&gt;

&lt;center&gt;◇ 青海湖 ◇&lt;/center&gt;

&lt;p&gt;生活在鳞次栉比的高楼大厦中的我们，像是圈养在笼子中的金丝雀，总渴望回归自然，感受广阔的天地，蔚蓝的大海，洁白的云朵，璀璨的星空……渴望着，盼望着，这次行程的重点打卡点出现在我们眼前。
青海湖，藏语名为 “措温布” （意为“青色的海”）。青海湖虽然是一个内陆湖，但是站在湖边一眼望不到对岸，仿佛是面对汪洋大海，却比以往见过的大海多了一分神韵。岸边牛羊恬静地吃着青草，高山白云依偎在旁，五彩的经幡随风飘摇，白鸟蓝鸥低空盘旋，青海湖像是一颗璀璨的宝石镶嵌在高原之上。微风吹拂着湖面，闭上双眼贪婪地享受着这一刻，如此的安逸、轻松，身边不再有尔虞我诈，不再有灯红酒绿，不再有追名逐利。&lt;/p&gt;

&lt;p&gt;如此美景怎会缺少美人，同行的几个小姑娘早早就选好了背景、摆好了pose，估计今晚的朋友圈九宫格应该有了着落。小F和小S却像是两个童心未泯的孩子一样玩起了荡秋千。&lt;/p&gt;

&lt;center&gt;“终日昏昏醉梦间，忽闻春尽强登山。因过竹院逢僧话，偷得浮生半日闲”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/荡秋千.jpg&quot; alt=&quot;荡秋千&quot; /&gt;&lt;/p&gt;
&lt;center&gt;回归童真&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/舞.jpg&quot; alt=&quot;舞&quot; /&gt;&lt;/p&gt;
&lt;center&gt;美美哒的小米姐&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/腿长一米八.jpg&quot; alt=&quot;腿长一米大&quot; /&gt;&lt;/p&gt;
&lt;center&gt;腿长一米八，大片范&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/青海湖.jpg&quot; alt=&quot;青海湖&quot; /&gt;&lt;/p&gt;
&lt;center&gt;美丽的青海湖（出自小F之手）&lt;/center&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt;Day2 | 日出·盐湖&lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;4月28日&lt;br /&gt;
行程：黑马河→橡皮山→茶卡盐湖→德令哈→可鲁克湖→大柴旦(宿)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;center&gt;◇ 日出 ◇&lt;/center&gt;

&lt;center&gt;...

你来人间一趟  

你要看看太阳

和你的心上人

一起走在街上

...&lt;/center&gt;

&lt;p&gt;来青海湖的人，想必都会在黑马河留宿一晚，只为了亲眼看一看黑马河的日出。黑马河日出，实则还是青海湖上的日出景象，只是从黑马河镇的位置看去。从鱼肚白到天光大亮前后也就十几分钟的时间，为了这短暂的美景，一行人在寒风中激动着搓着小手。在弯弯的湖畔，游客已提早拿出手机、摆好相机，在日出的那一刹那间，摄下那美好的瞬间，留下美好的记忆，记录下难以忘怀的瞬间，完成自己青海湖之行最后的心愿。&lt;/p&gt;

&lt;center&gt;“黑马河位于西宁以西约220公里处的青海湖边，是青海湖环湖公路的起点。秋天是看日出的最佳季节，而位于湖西岸的黑马河正是观看青海湖日出的最佳地点之一。”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/黑马河日出.jpg&quot; alt=&quot;黑马河日出1&quot; /&gt;&lt;/p&gt;
&lt;center&gt;黑马河日出（1）&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/日出剪影.jpg&quot; alt=&quot;黑马河日出2&quot; /&gt;&lt;/p&gt;
&lt;center&gt;黑马河日出（2）&lt;/center&gt;

&lt;center&gt;◇ 盐湖 ◇&lt;/center&gt;

&lt;p&gt;茶卡盐湖，被誉为中国的天空之镜，被人们描述得如诗如画，再加上抖音上无数小视频的感染，变成了来青海旅行不可或缺的一处美景。湖底是白色盐晶体，漫步其间，与倒影交相辉映，仿佛置身于天空之镜，亦梦亦幻，如同童话世界一般。&lt;/p&gt;

&lt;center&gt;“盐湖每年四月底开放，我们去的时候刚开放不久，门票免费，不过湖水较少，七八月为旺季（关爱盐湖，减少下水，随手带走个人垃圾）”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/茶卡盐湖1.jpg&quot; alt=&quot;茶卡盐湖&quot; /&gt;&lt;/p&gt;
&lt;center&gt;茶卡盐湖（1）&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/茶卡盐湖2.jpg&quot; alt=&quot;茶卡盐湖2&quot; /&gt;&lt;/p&gt;
&lt;center&gt;茶卡盐湖（2）&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/茶卡盐湖3.jpg&quot; alt=&quot;茶卡盐湖3&quot; /&gt;&lt;/p&gt;
&lt;center&gt;茶卡盐湖（3）&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/茶卡盐湖4.jpg&quot; alt=&quot;茶卡盐湖4&quot; /&gt;&lt;/p&gt;
&lt;center&gt;茶卡盐湖（4）&lt;/center&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt;Day3 | 雅丹·公路&lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;4月29日&lt;br /&gt;
行程：大柴旦→柳格公路→青海雅丹→当金山→阿克塞→阳关→敦煌(宿)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;center&gt;◇ 青海雅丹 ◇&lt;/center&gt;

&lt;p&gt;雅丹地貌，或者称为风蚀脊，是一种典型的风蚀性地貌。“雅丹”在维吾尔语中的意思是“具有陡壁的小山包”。由于风的磨蚀作用，小山包的下部往往遭受较强的剥蚀作用，并逐渐形成向里凹的形态。如果小山包上部的岩层比较松散，在重力作用下就容易垮塌形成陡壁，形成雅丹地貌，有些地貌外观如同古城堡，俗称魔鬼城。雅丹地貌分布于新疆、甘肃、柴达木盆地，青海雅丹则是属于柴达木盆地。&lt;/p&gt;

&lt;p&gt;初次听闻 “雅丹地貌” 好像是在高中地理书，当时就被一个个像是蘑菇的山包吸引，惊叹于大自然的鬼斧神工，希冀于一睹真容。转眼数载，登高远观，窥之一二，山包的迎风侧多陡峭，土质坚硬，离得几到几十米不等，背风面则为缓坡，土质松软。一个个山包像是拔地而起的竹笋，亦像是凸起的触手，阻挡着我们前行，为了安全起见加上地势起伏不定，不便于行车，我们并没有过于深入。踏上阿楠所属的山头，才感受到了什么叫做寒风刺骨，难怪多年的风沙侵蚀能形成这特殊地貌，换做是人，八成用不了十天半个月就成了肉干。&lt;/p&gt;

&lt;center&gt;“此次我们前往的地方名曰 “南八仙” ，是英雄的名字，据说是在 1955 年的时候，有八名来自南方的地质人员为探测石油来到这个地方，但不幸永生于此，后人为祭奠他们，命名此地为 “南八仙”。”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/青海雅丹.jpg&quot; alt=&quot;青海雅丹&quot; /&gt;&lt;/p&gt;
&lt;center&gt;迷途与路&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/青海雅丹小S.jpg&quot; alt=&quot;青海雅丹小S&quot; /&gt;&lt;/p&gt;
&lt;center&gt;魔鬼与少女（1）&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/青海雅丹小F.jpg&quot; alt=&quot;青海雅丹小F&quot; /&gt;&lt;/p&gt;
&lt;center&gt;魔鬼与少女（2）&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/青海雅丹小米.jpg&quot; alt=&quot;青海雅丹小米&quot; /&gt;&lt;/p&gt;
&lt;center&gt;魔鬼与少女（3）&lt;/center&gt;

&lt;center&gt;◇ 公路 ◇&lt;/center&gt;

&lt;p&gt;西部地区地域辽阔，人烟稀少，行程途中放眼望去一览无遗，零星的骆驼刺（可能是）点缀着茫茫大地，沿途最大的风景变成了大地、天空与公路。走在连接青海和甘肃公路上，才明白“要想富，先修路”这句话多么正确。一条公路不仅仅是连接着两个省，更是无数百姓的生命传送带，通过这条路他们交换粮食、物资，通过这条路他们可以走的更远，看更大的世界，通过这条路他们把不一样的景色展示给外面的人。&lt;/p&gt;

&lt;p&gt;行走在这条公路上，看着两侧的风景，与稀稀疏疏的车辆，小哥阿楠建议我们在这里把计划在“最美公路”要拍的照拍了，这里车辆少，安全，景色不比“最美公路”差。索性一行人开始装扮，墨镜、头巾、披纱、旅行箱、帽子，利用各种道具，旨在拍出酷酷的照片，而我就厉害了，什么都不需要，天然酷……装逼结束，上图。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/公路小S.jpg&quot; alt=&quot;公路小S&quot; /&gt;&lt;/p&gt;
&lt;center&gt;诗和远方&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/公路小米.jpg&quot; alt=&quot;公路小米&quot; /&gt;&lt;/p&gt;
&lt;center&gt;年轻的魅力&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/公路小F.jpg&quot; alt=&quot;公路小F&quot; /&gt;&lt;/p&gt;
&lt;center&gt;一字马&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/公路本尊.jpg&quot; alt=&quot;公路本尊&quot; /&gt;&lt;/p&gt;
&lt;center&gt;背影&lt;/center&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt;Day4 | 佛窟·绿洲&lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;4月30日&lt;br /&gt;
行程：敦煌→莫高窟→鸣沙山月牙泉→沙洲夜市→敦煌(宿)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;center&gt;◇ 佛窟 ◇&lt;/center&gt;

&lt;p&gt;飞驰在柴达木盆地，在这纯粹的景色中，心灵与蓝天从未如此的接近，仿佛与白云一同舞动在天地玄荒之中，化为宇宙间一粒飘扬的芥子，没有流浪的孤独，有的只是生命的自由。无限的空间迎面驰来，仿佛天地都在旋转，抬头望向远处，距离将所有的高度抹平，剩下的只是天地一线的浩渺；放眼望去，天似穹隆，笼盖四野，只有在这时，才理解古人为何会认为天圆地方。一切的语言都化作寂静的回响，所有的词汇都成为低沉的吟唱。大漠养不住生命，然而大漠却能启悟生命。大漠虽不是人类的福祉，却让人更加珍惜拥有的美好。&lt;/p&gt;

&lt;p&gt;“却君更尽一杯酒，西出阳关无故人”著名的阳关、玉门关,便在敦煌，敦煌是坐落在古代中国通往西域、中亚、欧洲的交通要道丝绸之路上的重要据点，是古时各方势力必争之地。而对于敦煌最为人知晓的还是有“千佛洞”之称的莫高窟，莫高窟同时也是世界上现存规模最宏大、保存最完好的佛教艺术宝库，经历了前秦、北朝、隋、唐、五代、西夏和元朝，成了一种代代相传的文化基因。&lt;/p&gt;

&lt;p&gt;进入莫高窟景区前，我们被安排观看数字影片，作为了解莫高窟的前期铺垫，本以为会是生硬的语调加上晦涩难懂的官方是介绍，出乎意料的是，敦煌研究院竟然以球幕电影的形式向游客介绍莫高窟的前世今生，浸入式的体验，仿佛身临其境，头顶、背后、两侧、正前方看你想看的，全方位的展现着佛窟内的壁画，现代科技加上古代杰作，带给人们别样的体验，更让莫高窟里的无价之宝以另一种形态永久保存。&lt;/p&gt;

&lt;p&gt;乘坐区间巴士，缓缓进入景区，放眼望去整片佛窟坐落于悬崖峭壁上，身后则是无尽的沙漠，荒芜之地却有超越生命的存在，着实让人震撼。在讲解员的带领下我们大约参观了 8 个佛窟，佛像形态各异，神色庄严，作为一介庸人，虽不了解佛的前世今生和佛家真谛，单从这些壁画、佛像表象依然有所触动。佛窟中壁画内容最为丰富，有佛像、佛教史迹、经变、神话、供养人等题材和装饰图案，甚至在朝代演变和各族各教文化交融中，壁画中囊括了西方宗教元素，民族文化。壁画中单论形态之美恐怕数“飞天”首屈一指，有脚踩祥云，徐徐降落、有昂首挥臂，腾空而上、有手捧鲜花，直冲云霄、有手托花盘，横空飘游，随风飘动的彩带与轻盈的神态，呼之欲出。&lt;/p&gt;

&lt;p&gt;这一伟大的历史瑰宝，却遭受多方面的破坏，主要有：一、宗教冲击、人为破坏。敦煌地处古代西域，是一个多民族多宗教的集合地，在各方势力迭代的过程中南面会有宗教冲突产生的人为破坏，好在明朝之前代代修缮，到晚清绝大多数佛窟仍然保存完好；二、风沙侵蚀、自然损坏。原莫高窟暴露在风沙中，饱受风沙侵蚀，1961年时，国家组织对莫高窟进行修缮，加固外壁、拱门、扶梯，防止山体变形导致佛窟受损；三、对外开放，破坏洞内空气成分导致。而今敦煌研究院致力于寻找开放和保护的平衡，在近百年的时间二氧化碳和水蒸气与壁画中的铅颜料发生反应，逐渐化为黑色，甚至发生鼓包脱落，越靠近地面的壁画腐蚀越来越严重，这一任务迫在眉睫；四、列强夺掠，文化遗矢。晚清时期王道士维护佛窟期间意外发现藏经洞，震惊中外，不幸的是，彼时的晚清政府无力保护这些无价之宝，5 万余件经书仅有8 千件入藏京师图书馆，还都是挑剩的残卷，无数件壁画被洗劫一空。涉及四世纪到十一世纪中国古代的政治、经济、军事、文学、史地、医药、科技、民族、宗教、艺术等各领域的文化瑰宝散落在全球各地，实为我国史学的一大痛心之事。&lt;/p&gt;

&lt;center&gt;“前秦建元二年（366年），僧人乐尊路经此山，忽见金光闪耀，如现万佛，于是便在岩壁上开凿了第一个洞窟。此后法良禅师等又继续在此建洞修禅，称为“漠高窟”，意为“沙漠的高处”。后世因“漠”与“莫”通用，便改称为“莫高窟”。再经历代王公贵族支持，逐步开凿，直至现今之态”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/莫高窟.jpg&quot; alt=&quot;莫高窟&quot; /&gt;&lt;/p&gt;
&lt;center&gt;莫高窟（佛窟禁止拍照，仅此一图）&lt;/center&gt;

&lt;center&gt;◇ 绿洲 ◇&lt;/center&gt;

&lt;p&gt;“晴空万里蔚兰天，美绝人寰月牙泉，银山四面沙环抱，一池清水绿漪涟。” 坐落于敦煌市西南 5 公里鸣沙山北麓的月牙泉名声并不比莫高窟小多少，曾经出现在小学语文课本中的经典景点，也成为了我们此行的重点之一。在前往莫高窟的前一晚，我们已经在鸣沙山脚体验过沙漠的热情，在滚烫的沙子，潇潇的风声陪伴下，滑沙、骑摩托、吃火锅、篝火、露营……&lt;/p&gt;

&lt;center&gt;“第一次睡帐篷就献给了鸣沙山”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/露营.jpg&quot; alt=&quot;露营&quot; /&gt;&lt;/p&gt;
&lt;center&gt;露营&lt;/center&gt;

&lt;p&gt;爬沙的辛苦并没能阻挡住我们的热情，为了那一弯绿洲，再累都是值得的。月牙泉是沙漠中一处奇观。鸣沙山下，泉水形成一湖，在沙丘环抱之中，酷似一弯新月而得名月牙泉。泉边芦苇丛生，水中鱼儿自在，胡杨沙枣绿树成荫，罗布麻、枸杞等药用植物丰茂，亭台楼榭古香古色。一弯清泉，涟漪萦回，碧如翡翠。泉在流沙中，干旱不枯竭，风吹沙不落，蔚为奇观。&lt;/p&gt;

&lt;center&gt;“一弯如月弦初上，半壁清波镜比明，风卷飞沙终不到，渊含止水正相生。”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/月牙泉全景.jpg&quot; alt=&quot;月牙泉全景&quot; /&gt;&lt;/p&gt;
&lt;center&gt;月牙泉&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/沙洲起舞.jpg&quot; alt=&quot;沙洲起舞&quot; /&gt;&lt;/p&gt;
&lt;center&gt;沙洲起舞&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/勿忘阿楠.jpg&quot; alt=&quot;勿忘阿楠&quot; /&gt;&lt;/p&gt;
&lt;center&gt;小哥阿楠送的小礼物&lt;/center&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt;Day5 | 丹霞&lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;5月1日&lt;br /&gt;
行程：敦煌→瓜州→嘉峪关→张掖丹霞(宿)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;center&gt;◇ 丹霞 ◇&lt;/center&gt;

&lt;p&gt;五花肉，哦不，是七彩丹霞是甘肃省张掖市的一大旅游景点，景区内随处可见有红、黄、橙、绿、白、青灰、灰黑、灰白等多种鲜艳的色彩，把无数沟、山丘装点得绚丽多姿。张掖丹霞地貌以层理交错的线条、色彩斑斓的色调、灿烂夺目的壮美画图，形一个彩色童话世界。远远望去像极了五花肉，再来一把孜然、辣椒面，一瓶凉啤酒，哇咔咔，流口水了。&lt;/p&gt;

&lt;center&gt;“七彩丹霞的美，在夕阳西下时更能展现出，因此，游客往往选择在日落前进入景区，在 4 号观景台欣赏日落。注意景区入园截止时间，预留足够时间以免错误日落”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/七彩丹霞.jpg&quot; alt=&quot;七彩丹霞&quot; /&gt;&lt;/p&gt;
&lt;center&gt;七彩丹霞&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/七彩丹霞1.jpg&quot; alt=&quot;七彩丹霞1&quot; /&gt;&lt;/p&gt;
&lt;center&gt;七彩丹霞1&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/七彩丹霞3.jpg&quot; alt=&quot;七彩丹霞2&quot; /&gt;&lt;/p&gt;
&lt;center&gt;七彩丹霞2&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/七彩丹霞4.jpg&quot; alt=&quot;七彩丹霞3&quot; /&gt;&lt;/p&gt;
&lt;center&gt;七彩丹霞3&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/七彩丹霞5.jpg&quot; alt=&quot;七彩丹霞4&quot; /&gt;&lt;/p&gt;
&lt;center&gt;日落中的七彩五花肉&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/丹霞落日.jpg&quot; alt=&quot;丹霞日落&quot; /&gt;&lt;/p&gt;
&lt;center&gt;落日余晖&lt;/center&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt;Day6 | 归&lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;5月2日&lt;br /&gt;
行程：张掖→扁都口→峨堡镇→祁连草原→西宁&lt;/p&gt;
&lt;/blockquote&gt;

&lt;center&gt;◇ 归 ◇&lt;/center&gt;

&lt;p&gt;回家的路总是很长很长，此时的我们却觉得这条路还不够长，不想离开这个美丽的地方。最后一天的行程，原本是可以看到祁连大草原和一大片油菜花，不过 5 月对于青海甘肃还是太过寒冷，小草都不愿意抬起额头。伴随着 1、2、3……数不清的 180 度大转弯的盘山路，路过祁连山大草原、俄堡古城，海拔逐步由 1000+ 升到3000+ ，我们再次回到了青藏高原。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/祁连山.jpg&quot; alt=&quot;祁连山&quot; /&gt;&lt;/p&gt;
&lt;center&gt;祁连山路&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/打耳光.jpg&quot; alt=&quot;打耳光&quot; /&gt;&lt;/p&gt;
&lt;center&gt;小哥哥，小哥哥，我可以扇你一耳光吗&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/仰望.jpg&quot; alt=&quot;仰望&quot; /&gt;&lt;/p&gt;
&lt;center&gt;太阳好晃眼，打个喷嚏吧&lt;/center&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt; 美食推荐 &lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;center&gt;&quot;炮仗 —— 提到青海、甘肃的特色饭菜，位居榜首的肯定是面食，在青海吃到的面食中最棒的要数“炮仗”，分 500 响和 1000 响，其实就是大小份，之所以叫炮仗呢，是因为面条被切成了一节一节的形同炮仗，故名曰“炮仗”。&quot;&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/炮仗.jpg&quot; alt=&quot;炮仗&quot; /&gt;&lt;/p&gt;
&lt;center&gt;500 响的炮仗&lt;/center&gt;

&lt;center&gt;“铁板炕牛肉 —— 在黑马河的一家餐馆吃到的美味，仅仅售价 88 元，却可以吃到一大盘牦牛肉，土豆和土豆粉中沁入的牛肉汁甚是美味。”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/铁板炕牦牛肉.jpg&quot; alt=&quot;铁板炕牦牛肉&quot; /&gt;&lt;/p&gt;
&lt;center&gt;铁板炕牦牛肉&lt;/center&gt;

&lt;center&gt;“土火锅肉 —— 大概是西宁一带的传统美味吧，不同于我们日常吃到的火锅，土火锅是预先把菜食加入锅中，待菜食快熟之时再盛上餐桌，火锅中的羊肉味道极其鲜美”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/土火锅.jpg&quot; alt=&quot;土火锅&quot; /&gt;&lt;/p&gt;
&lt;center&gt;土火锅&lt;/center&gt;

&lt;center&gt;“过桥仙居 —— 坐落于新千百盛商场四楼，云南菜系。这个放菜谱的盒子甚是夸张，他家的菜品味道可口，器皿很美观、讲究，价格远比想象中的低。”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/过桥仙居.jpg&quot; alt=&quot;过桥仙居&quot; /&gt;&lt;/p&gt;
&lt;center&gt;过桥仙居菜谱&lt;/center&gt;

&lt;center&gt;“招牌骨汤米线 —— 过桥仙居推荐第 1 名”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/招牌骨汤米线.jpg&quot; alt=&quot;招牌骨汤米线&quot; /&gt;&lt;/p&gt;
&lt;center&gt;招牌骨汤米线&lt;/center&gt;

&lt;center&gt;“玫瑰花茶 —— 过桥仙居推荐第 2 名，第 1 杯免费，该店自制，不对外销售”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/花茶.jpg&quot; alt=&quot;花茶&quot; /&gt;&lt;/p&gt;
&lt;center&gt;玫瑰花茶&lt;/center&gt;

&lt;center&gt;“二师兄的拳法 —— 烤猪蹄，装盘精美，还有烤鸡爪、鸭掌，同样装盘精美，鸡爪用鸡盘，鸭掌用鸭盘…”&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/二师兄的拳法.jpg&quot; alt=&quot;二师兄的拳法&quot; /&gt;&lt;/p&gt;
&lt;center&gt;二师兄的拳法&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/二师兄的拳法2.jpg&quot; alt=&quot;二师兄的拳法2&quot; /&gt;&lt;/p&gt;
&lt;center&gt;二师兄的拳法2&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/过桥仙居菜.jpg&quot; alt=&quot;过桥仙居菜&quot; /&gt;&lt;/p&gt;
&lt;center&gt;四个人吃的饱饱的&lt;/center&gt;

&lt;center&gt;位于张掖热情好客的“江湖菜”菜馆，一曲敬酒歌，三杯青稞酒&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/江湖菜.jpg&quot; alt=&quot;江湖菜&quot; /&gt;&lt;/p&gt;
&lt;center&gt;江湖菜&lt;/center&gt;

&lt;center&gt;敦煌风情街中一家名为“帅厨”的餐馆，有一种酸菜火锅，铜火锅中放着酸菜，带一大大大盘手切羊肉（估摸着至少有一斤多），一盘油麦菜，味美，汤香，仅需 98 ，由于忘记拍照，图片略过。&lt;/center&gt;

&lt;center&gt;同样略过的还有“驴肉黄面”、“粉汤”...&lt;/center&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt; 小插曲 &lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;1、黑马河吃饭的时候遇到 3 位从内蒙古达拉特旗自驾去西藏的大哥，亲切的乡音，暖暖的鄂尔多斯敬酒，大赞！&lt;/p&gt;

&lt;p&gt;2、在张掖七彩丹霞景区外不远处的江湖菜馆，看到两坛青稞酒，原本只想讨一杯尝尝，没曾想老板娘让两名小哥送上了敬酒歌，每人三杯青稞酒下肚，暖暖的，也感受到了当地人的热情。&lt;/p&gt;

&lt;p&gt;3、西宁过桥仙居，尝了一口玫瑰花茶便爱上了这个味道，死活要和老板买一些带走，无奈并不对外销售，惊喜的是临走前老板赠送了我们 4 份~&lt;/p&gt;

&lt;p&gt;4、茶卡盐湖 4 月 26 日开放，刚好赶上，而且是免门票。&lt;/p&gt;

&lt;p&gt;5、七彩丹霞 6 点截止进入景区，下车一路小跑过去，买到门票才知道五一节假日 7 点截止，幸好，不然就错过了。&lt;/p&gt;

&lt;p&gt;6、莫高窟 5 月 1 日进入旺季，门票 200 ，我们 4 月 30 日抵达~&lt;/p&gt;

&lt;p&gt;7、从北京出发前天气预报显示青海会有降雨，海西、海北会有降雪，去了后天晴气爽。&lt;/p&gt;

&lt;p&gt;8、第一次住青旅，比想象中的好，变样的体验，自由中夹杂着诗意。&lt;/p&gt;
&lt;center&gt;&quot;彩门青旅（西宁建材巷店）,陈坤入住过的地方&quot;&lt;/center&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/qinghai/彩门青旅.png&quot; alt=&quot;彩门青旅&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;center&gt; 写在最后 &lt;/center&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;看到这里可能会好奇为什么没有写住宿、门票、交通这些方面的攻略，其实原因很简单，青海环线这么多年来早就成为青海最常见的旅游方式，随之而生的是价格公道、热情周到的车队服务，只需要付包车费用，住宿、吃饭、交通、兼职导游一键get√，而且很多地方没有中间商赚差价，没有购物消费，时间自己安排，省心省事还玩的开心。感谢一路同行的小F、小S、小米姐已经“八一同游车队”的阿楠。&lt;/p&gt;</content><author><name>Barry New</name></author><summary type="html">巍巍昆仑山脚下,</summary></entry><entry><title type="html">游 | 一个人的玩耍 · 石花洞</title><link href="https://kago.site/2018/03/10/shihuadong/" rel="alternate" type="text/html" title="游 | 一个人的玩耍 · 石花洞" /><published>2018-03-10T00:00:00+08:00</published><updated>2018-03-10T00:00:00+08:00</updated><id>https://kago.site/2018/03/10/shihuadong</id><content type="html" xml:base="https://kago.site/2018/03/10/shihuadong/">&lt;blockquote&gt;
  &lt;p&gt;年后以来，心中一直感觉憋着什么，没地方发泄，可能来自工作，可能来自那段失败的感情，也有可能出于对自己现状的焦躁，总想找个方式去宣泄或者去逃避…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;写在前面&quot;&gt;写在前面&lt;/h3&gt;

&lt;p&gt;很多时候不会隐藏自己的情绪，心情不好时全都写在脸上，板着脸不说话，一度小M来公司的时候觉得我很严厉是一个不和谐的存在；心情好的时候又无所顾忌地表达着，甚至是手舞足蹈的向身边人分享喜悦，时而逗比时而傻逼，没能把自己的情绪控制在自己的小世界里，没能“装”出一副沉稳的样子，往往被别人定义为“幼稚”，尤其是当你在意的人对你如此评价，心中阵阵刺痛。&lt;/p&gt;

&lt;p&gt;对标知乎中一位网友对成熟的定义：&lt;strong&gt;“不需要靠一切阿谀外界的行为来获得安全感。不需要靠一切贬损外界的行为来获得优越感。不需要靠外界的一切褒扬来获得存在感。”&lt;/strong&gt; 细细想来确实是有一些，最起码我都不能很好的独处：不想一个人回到住处，不想面对黑暗的房间（以至于买了智能台灯、智能灯带让我打开门的时候房间至少是亮着的），不喜欢赖床，不喜欢一个人出去玩，不喜欢一个人逛商场…有想做的事情时，向身边的朋友发一圈邀请，往往都会被拒绝，导致近期一个人去商场、一个人去超市、一个人去游戏厅抓娃娃、一个人去看电影、一个人去吃火锅，起初觉得有一丝丝悲凉的赶脚，但觉得这样的事还是应该学会适应，毕竟这样才不会在失去某些人某些东西的时候适应不来。&lt;/p&gt;

&lt;p&gt;既然还有很多事情要一个人去做，那就来一次说走就走的玩耍吧。&lt;/p&gt;

&lt;h3 id=&quot;一个人的游玩&quot;&gt;一个人的游玩&lt;/h3&gt;

&lt;p&gt;前两天想去公园赏花，奈何还不到赏花的时节，但是又想出去散散心，突然想到去年的时候小Y去过一次石花洞，据说还不错。想干就干，周六就去！&lt;/p&gt;

&lt;h4 id=&quot;出发&quot;&gt;出发&lt;/h4&gt;

&lt;p&gt;6:30 起床洗漱，背包里装了前一天备好的零食、热水，带上耳机路上听书消磨时光&lt;/p&gt;

&lt;p&gt;7:00 出发乘坐 694 到六里桥东- 快901到阎村 - 房43到石花洞&lt;/p&gt;

&lt;p&gt;中间有一个小插曲，到阎村的时候，并没有找到地图上显示的公交站，一问当地的一位大叔，原来房43刚走三两分钟，坑爹的房43路每隔1小时发车一趟，难道要凉了？还好灵机一动立马去快901下车的地方坐 833路 超过上班车提前到辛开口站换乘房43，运气不错刚下833路不到两分钟房43就紧随起来（房43略比833绕一些，所以有一个时间差）。&lt;/p&gt;

&lt;h4 id=&quot;参观溶洞&quot;&gt;参观溶洞&lt;/h4&gt;

&lt;p&gt;10:00 到达石花洞景区&lt;/p&gt;

&lt;p&gt;由于石花洞是地下溶洞，台阶湿滑，而且洞内灯光开一次只保持几分钟（据说是有热光源防止长青苔，后悔没带个手电筒🔦），因此每次进洞都会攒够人数由导游带路，大约等到 10:25 的时候，工作人员开始检票放行，一行人终于进到了石花洞内。&lt;/p&gt;

&lt;p&gt;石花洞是 1981 年开始开放，总共有 7 层，目前只开放前 4 层，据说第 7 层是地下河正在开发中，1~4 层全长 2500 米，大约游玩需要 90 分钟，洞内不设卫生间。&lt;/p&gt;

&lt;p&gt;丢几张洞内景观&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/shihuadong/1.jpg&quot; alt=&quot;1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/shihuadong/2.jpg&quot; alt=&quot;2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/shihuadong/3.jpg&quot; alt=&quot;3&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/shihuadong/4.jpg&quot; alt=&quot;4&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/shihuadong/5.jpg&quot; alt=&quot;5&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/shihuadong/6.jpg&quot; alt=&quot;6&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/shihuadong/7.jpg&quot; alt=&quot;7&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;出洞&quot;&gt;出洞&lt;/h4&gt;

&lt;p&gt;差不多 12：00 左右从石花洞出来，由于石花洞成年保持 13℃ 左右的温度，洞内潮湿下到 4  层后微微有些热，再出洞时，身上已经冒出了小汗珠。&lt;/p&gt;

&lt;p&gt;顺着指示牌，一遍参观旅游纪念品一边向着公交站走去，走到公交站已经12:20错过了上一班车（11:10、12:10、13:10…每隔一小时从石花洞发车一趟）。
错过了那就索性等下一趟，先吃饭，在车站对面选了家名叫车营餐厅的当地小饭店，老板上了年纪耳朵不太好但是手艺不错，点了一盘什么什么豆腐的，和一盘落地菜（并不知道什么叫落地菜，好奇才点的，上来后发现是一道冷拌的），下图是 53 大洋的中午饭：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/shihuadong/8.jpg&quot; alt=&quot;8&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;返程&quot;&gt;返程&lt;/h4&gt;

&lt;p&gt;13:10 准时发车返程，一路无话…&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/shihuadong/9.jpg&quot; alt=&quot;9&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;再哔哔两句&quot;&gt;再哔哔两句&lt;/h3&gt;

&lt;p&gt;虽然时间大部分消耗在了路上，但自娱自乐足够了…原本打算找一有天材地宝的世外之地，静坐感悟人生，奈何没有那个天赋异能，心散没散了不知道，但至少溜了腿，也算是充实的一天吧。&lt;/p&gt;</content><author><name>Barry New</name></author><summary type="html">年后以来，心中一直感觉憋着什么，没地方发泄，可能来自工作，可能来自那段失败的感情，也有可能出于对自己现状的焦躁，总想找个方式去宣泄或者去逃避…</summary></entry><entry><title type="html">用 Travis CI 免费自动构建和部署 Jekyll</title><link href="https://kago.site/2018/01/25/travis-ci-for-jekyll/" rel="alternate" type="text/html" title="用 Travis CI 免费自动构建和部署 Jekyll" /><published>2018-01-25T00:00:00+08:00</published><updated>2018-01-25T00:00:00+08:00</updated><id>https://kago.site/2018/01/25/travis-ci-for-jekyll</id><content type="html" xml:base="https://kago.site/2018/01/25/travis-ci-for-jekyll/">&lt;blockquote&gt;
  &lt;p&gt;前一段时间搭建了个人博客，一直说要记录一下搭建过程，由于懒拖到现在……我的博客的搭建过程分为两阶段，第一阶段是利用 Github Pages 蹭免费环境，启动博客；第二阶段是利用 Travsi 持续集成，把环境迁到自己的云服务器。之所以迁到自己的云服务器，主要原因是 Github Pages 禁止百度蜘蛛，意味着百度不能收录网站，搜索站点名称的时候就搜索不到，这对于我这种喜欢“炫耀”的银来说必须不能接受。本文介绍在云服务器中搭建博客的完整过程。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;整个搭建过程思路如下：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;fork 博客到 Github ，修改博客属性&lt;/li&gt;
  &lt;li&gt;本地 Markdown 编写博客，push md 文件到 Github&lt;/li&gt;
  &lt;li&gt;配置 Travis CI 执行自动编译，生成 html 文件&lt;/li&gt;
  &lt;li&gt;编译后 Travis CI push html文件到新的 Github 仓库&lt;/li&gt;
  &lt;li&gt;Travis CI 重启云服务器中的容器，拉取 Github 中的 html 文件完成更新&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;1-利用-github-pages-搭建个人博客&quot;&gt;1. 利用 Github Pages 搭建个人博客&lt;/h3&gt;

&lt;p&gt;利用 Github Pages 搭建个人博客在网上已经有很多资料了，有的人可能会觉得这是在占小便宜，其实完全是多虑了， Github 是鼓励个人建站滴，所以放下大胆的享受红利吧。&lt;/p&gt;

&lt;p&gt;想要享受 Github 的红利当然前提条件是要有 Github 账户，注册方法就不提了，我们直接开始 fork 博客模板。&lt;/p&gt;

&lt;p&gt;这里我使用的是大佬&lt;a href=&quot;https://github.com/mzlogin/mzlogin.github.io&quot;&gt;马壮&lt;/a&gt;修改样式后的模板，fork 以后需要做以下修改：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;正确设置项目名称与分支。&lt;/p&gt;

    &lt;p&gt;按照 GitHub Pages 的规定，名称为 username.github.io 的项目的 master 分支，或者其它名称的项目的 gh-pages 分支可以自动生成 GitHub Pages 页面。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;修改域名。&lt;/p&gt;

    &lt;p&gt;如果你需要绑定自己的域名，那么修改 CNAME 文件的内容；如果不需要绑定自己的域名，那么删掉 CNAME 文件。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;修改配置。&lt;/p&gt;

    &lt;p&gt;网站的配置基本都集中在 _config.yml 文件中，将其中与个人信息相关的部分替换成你自己的，比如网站的 url、title、subtitle 和第三方评论模块的配置等。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;评论模块:&lt;br /&gt;
 目前支持 disqus、gitment 和 gitalk，选用其中一种就可以了。可参看以前的博文 &lt;a href=&quot;https://kago.site/2017/12/09/gitment/&quot;&gt;「jekyll中添加gitment留言板」&lt;/a&gt;。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;删除原有的文章与图片。&lt;/p&gt;

    &lt;p&gt;如下文件夹中除了 template.md 文件外，都可以全部删除，然后添加你自己的内容。&lt;br /&gt;
     _posts 文件夹中是已发布的博客文章。&lt;br /&gt;
     _drafts 文件夹中是尚未发布的博客文章。&lt;br /&gt;
     _wiki 文件夹中是已发布的 wiki 页面。&lt;br /&gt;
     images 文件夹中是文章和页面里使用的图片。&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;修改「关于」页面。&lt;/p&gt;

    &lt;p&gt;pages/about.md 文件内容对应网站的「关于」页面，里面的内容多为个人相关，将它们替换成你自己的信息，包括 _data 目录下的 skills.yml 和 social.yml 文件里的数据。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;修改完后，增加 CNAME 中的域名与 Github Pages 解析关系，登录到购买域名的网站增加域名到 192.30.252.153 的解析。其中， 192.30.252.153 是Github Pages 的服务器地址。接下来，就可以打开浏览器访问你的博客啦~&lt;/p&gt;

&lt;p&gt;Clone 你的网站代码库到本地，使用常见的编辑器（本人使用的是 vs code ）写博客，然后再push到 Github 即可。由于该该博客模板是利用 Jekyll 实现的静态网站，支持 Markdown ，这简直是太方便了，按照 Markdown 的语法尽情的写博客就好了， Github Pages 会自动识别 Markdown 格式的。&lt;/p&gt;

&lt;h3 id=&quot;2-利用-travis-持续集成&quot;&gt;2. 利用 Travis 持续集成&lt;/h3&gt;

&lt;h4 id=&quot;21-添加-github-仓库至-travis&quot;&gt;2.1 添加 Github 仓库至 Travis&lt;/h4&gt;

&lt;p&gt;利用 Travis 部分要感谢 &lt;a href=&quot;https://mritd.me/&quot;&gt;漠然&lt;/a&gt; 在博客中分析的他的实现方法。&lt;/p&gt;

&lt;p&gt;注册 Travis CI 账号，然后点击最左侧 + 按钮添加项目&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/增加仓库.png&quot; alt=&quot;增加仓库&quot; /&gt;&lt;/p&gt;

&lt;p&gt;选择添加到 Travis 的仓库&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/选择仓库.png&quot; alt=&quot;选择仓库&quot; /&gt;&lt;/p&gt;

&lt;p&gt;点击仓库旁的设置&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/配置仓库.png&quot; alt=&quot;配置仓库&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;22-创建travisyaml&quot;&gt;2.2 创建.travis.yaml&lt;/h4&gt;
&lt;p&gt;在博客的根路径下创建 .travis.yaml 配置文件，实现基本集成配置：&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;language&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ruby&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;rvm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2.3.3&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle install&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle exec jekyll build&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;branches&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;master&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;global&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;NOKOGIRI_USE_SYSTEM_LIBRARIES=true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;更多travis.yaml配置参考官方文档 &lt;a href=&quot;https://docs.travis-ci.com/&quot;&gt;https://docs.travis-ci.com/&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&quot;23-添加-deploy-keys&quot;&gt;2.3 添加 deploy keys&lt;/h4&gt;

&lt;p&gt;在 .travis.yaml 中进行加密配置，是为了使 Travis CI 可以免密码访问 Github&lt;/p&gt;

&lt;p&gt;生成密钥对，并添加公钥至 Github 的Deploy keys&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ssh-keygen &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; rsa &lt;span class=&quot;nt&quot;&gt;-C&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;youremail@example.com&quot;&lt;/span&gt;  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/images/posts/travis/deploy_keys.png&quot; alt=&quot;deploy_keys&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;24-安装并登陆travis&quot;&gt;2.4 安装并登陆travis&lt;/h4&gt;

&lt;p&gt;此步骤主要是为了生成 travis 的 keys&lt;/p&gt;

&lt;p&gt;安装&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gem install travis
travis login &lt;span class=&quot;nt&quot;&gt;--auto&lt;/span&gt;
Successfully logged &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;as niuchp!
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;25-加密&quot;&gt;2.5 加密&lt;/h4&gt;

&lt;p&gt;在加密之前我们先在项目根目录下需有 .travis.yaml 文件。加密的就是第一步生成的密钥id_rsa&lt;/p&gt;

&lt;p&gt;拷贝在 2.3 步骤中生成密钥对至项目根目录下，并执行：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;travis encrypt-file ssh_key &lt;span class=&quot;nt&quot;&gt;--add&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这时候看最后一句**Commit all changes to your .travis.yml.。&lt;/p&gt;

&lt;p&gt;我们的 .travis.yaml 文件中多了一句:(私人内容使用XXX代替)&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;openssl aes-256-cbc -K $encrypted_XXXXXXXX_key -iv $encrypted_XXXXXXXX_iv -in id_rsa.enc -out ~/.ssh/id_rsa -d&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;例如：&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;language&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ruby&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;rvm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2.3.3&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;before_install&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;openssl aes-256-cbc -K $encrypted_xxxxxxx_key -iv $encrypted_xxxxxxx_iv -in id_rsa.enc -out ~/.ssh/id_rsa -d&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;chmod 600 ~/.ssh/id_rsa&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle install&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle exec jekyll build&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;global&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;NOKOGIRI_USE_SYSTEM_LIBRARIES=true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;再次查看我们的 Travis CI 网页，发现多了一些变化&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/加密.png&quot; alt=&quot;加密&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;记得要删除 id_rsa 文件，私钥文件已经由 id_rsa.enc 替代&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;26-配置自动更新&quot;&gt;2.6 配置自动更新&lt;/h4&gt;

&lt;p&gt;自动更新部分是利用 Travis CI push 编译后的文件至一个新的代码库，重启容器触发 git pull 实现的。&lt;/p&gt;

&lt;p&gt;Travis CI push 静态文件到 Github 通过 Github 的 token 实现授权，代码如下&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;after_success&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git clone https://github.com/niuchp/kago.site.git&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cd kago.site &amp;amp;&amp;amp; rm -rf * &amp;amp;&amp;amp; cp -r ../_site/* .&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git config user.name &quot;niuchp&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git config user.email &quot;niuchp@126.com&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git add --all .&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git commit -m &quot;Travis CI Auto Builder&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git push --force https://$JEKYLL_GITHUB_TOKEN@github.com/niuchp/kago.site.git master&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ssh root@kago.site &quot;docker restart kago_site&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;注意： 配置文件中的kago.site.git为新仓库！&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;其中，JEKYLL_GITHUB_TOKEN 是从 Github 授权得到的，然后给于相应权限即可&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/travis_deploy_keys.png&quot; alt=&quot;travis_deploy_keys&quot; /&gt;&lt;/p&gt;

&lt;p&gt;得到JEKYLL_GITHUB_TOKEN后在 Travish CI的项目配置中添加环境变量$JEKYLL_GITHUB_TOKEN 如下图:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/posts/travis/env.png&quot; alt=&quot;env&quot; /&gt;&lt;/p&gt;

&lt;p&gt;完整的 .travis.yaml 配置文件如下：&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;language&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ruby&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;rvm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;2.3.3&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;before_install&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;openssl aes-256-cbc -K $encrypted_xxxxxxx_key -iv $encrypted_xxxxxxx_iv -in id_rsa.enc -out ~/.ssh/id_rsa -d&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;chmod 600 ~/.ssh/id_rsa&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle install&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bundle exec jekyll build&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;after_success&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git clone https://github.com/niuchp/kago.site.git&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cd kago.site &amp;amp;&amp;amp; rm -rf * &amp;amp;&amp;amp; cp -r ../_site/* .&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git config user.name &quot;niuchp&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git config user.email &quot;niuchp@126.com&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git add --all .&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git commit -m &quot;Travis CI Auto Builder&quot;&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;git push --force https://$JEKYLL_GITHUB_TOKEN@github.com/niuchp/kago.site.git master&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ssh root@kago.site &quot;docker restart kago_site&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;branches&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;only&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;master&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;global&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;NOKOGIRI_USE_SYSTEM_LIBRARIES=true&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;addons&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;ssh_known_hosts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kago.site&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;3-配置-docker-容器&quot;&gt;3. 配置 docker 容器&lt;/h3&gt;

&lt;p&gt;Travis CI 持续集成后会重启云服务器中的 docker 容器，触发 git pull 完成更新。&lt;/p&gt;

&lt;p&gt;Dockerfile&lt;/p&gt;

&lt;div class=&quot;language-dockerfile highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; nginx:1.13.6-alpine &lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;LABEL&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; maintainer=&quot;Barry New &amp;lt;niuchp@126.com&amp;gt;&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ARG&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; TZ='Asia/Shanghai'&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; TZ ${TZ}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;RUN &lt;/span&gt;apk upgrade &lt;span class=&quot;nt&quot;&gt;--update&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apk add bash git &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; /usr/share/nginx/html &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; git clone https://github.com/niuchp/kago.site.git /usr/share/nginx/html &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; ln &lt;span class=&quot;nt&quot;&gt;-sf&lt;/span&gt; /usr/share/zoneinfo/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; /etc/localtime &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;TZ&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/timezone &lt;span class=&quot;se&quot;&gt;\
&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; /var/cache/apk/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; entrypoint.sh /entrypoint.sh&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;COPY&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; default.conf /etc/nginx/conf.d/&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;WORKDIR&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; /usr/share/nginx/html&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;CMD&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; [&quot;/entrypoint.sh&quot;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;entrypoint.sh&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;

git pull
nginx &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;daemon off;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;default.conf&lt;/p&gt;

&lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; {
    &lt;span class=&quot;n&quot;&gt;listen&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;443&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;server_name&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;localhost&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl_certificate&lt;/span&gt;  /&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;share&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nginx&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;ssl&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;fullchain&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;cer&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl_certificate_key&lt;/span&gt;  /&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;share&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nginx&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;ssl&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;;
    &lt;span class=&quot;c&quot;&gt;#charset koi8-r;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#access_log  /var/log/nginx/host.access.log  main;
&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; / {
        &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;   /&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;share&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nginx&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;htm&lt;/span&gt;;
    }

    &lt;span class=&quot;c&quot;&gt;#error_page  404              /404.html;
&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# redirect server error pages to the static page /50x.html
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;error_page&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;502&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;503&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;504&lt;/span&gt;  /&lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; = /&lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt; {
        &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;   /&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;share&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nginx&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt;;
    }

    &lt;span class=&quot;c&quot;&gt;# proxy the PHP scripts to Apache listening on 127.0.0.1:80
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#location ~ \.php$ {
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    proxy_pass   http://127.0.0.1;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#}
&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#location ~ \.php$ {
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    root           html;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    fastcgi_pass   127.0.0.1:9000;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    fastcgi_index  index.php;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    include        fastcgi_params;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#}
&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# deny access to .htaccess files, if Apache's document root
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;# concurs with nginx's one
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#location ~ /\.ht {
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#    deny  all;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#}
&lt;/span&gt;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;到此，整个配置过程就结束了，可以通过 git push 触发 Travis CI 进行测试。&lt;/p&gt;</content><author><name>Barry New</name></author><summary type="html">前一段时间搭建了个人博客，一直说要记录一下搭建过程，由于懒拖到现在……我的博客的搭建过程分为两阶段，第一阶段是利用 Github Pages 蹭免费环境，启动博客；第二阶段是利用 Travsi 持续集成，把环境迁到自己的云服务器。之所以迁到自己的云服务器，主要原因是 Github Pages 禁止百度蜘蛛，意味着百度不能收录网站，搜索站点名称的时候就搜索不到，这对于我这种喜欢“炫耀”的银来说必须不能接受。本文介绍在云服务器中搭建博客的完整过程。</summary></entry><entry><title type="html">etcd集群安装及基本操作</title><link href="https://kago.site/2018/01/24/etcd-cluster/" rel="alternate" type="text/html" title="etcd集群安装及基本操作" /><published>2018-01-24T00:00:00+08:00</published><updated>2018-01-24T00:00:00+08:00</updated><id>https://kago.site/2018/01/24/etcd-cluster</id><content type="html" xml:base="https://kago.site/2018/01/24/etcd-cluster/">&lt;blockquote&gt;
  &lt;p&gt;etcd 是 kubernetes 中默认使用的键值存储系统，相当于是 kubernetes 集群的大脑，那么 etcd 怎么安装使用呢？下面为常用的集群配置及基本操作。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;etcd 是一个用于共享配置和服务的高可用键值存储系统，由 CoreOS 使用开发并作为 CoreOS 的基础服务启动。etcd 的灵感来源于 Apache ZooKeeper 和 doozer，其特点：&lt;/p&gt;

&lt;p&gt;· 简单：可用 curl 进行操作（HTTP+JSON） &lt;br /&gt;
· 安全：可使用 SSL 客户端证书验证&lt;br /&gt;
· 快速：基准测试在每个实例 1000 次写入每秒&lt;br /&gt;
· 可靠: 使用 Raft 协议来进行合理的分布式&lt;/p&gt;

&lt;h3 id=&quot;官方网站&quot;&gt;官方网站&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/coreos/etcd/&quot;&gt;https://github.com/coreos/etcd/&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;安装环境&quot;&gt;安装环境&lt;/h3&gt;

&lt;p&gt;操作系统： CentOS7&lt;br /&gt;
etcd版本： 3.0.4&lt;br /&gt;
3节点集群示例&lt;br /&gt;
etcd0: 192.168.8.101&lt;br /&gt;
etcd1: 192.168.8.102&lt;br /&gt;
etcd2: 192.168.8.103&lt;/p&gt;

&lt;h3 id=&quot;安装etcd集群&quot;&gt;安装etcd集群&lt;/h3&gt;

&lt;h4 id=&quot;一安装软件包&quot;&gt;一、安装软件包&lt;/h4&gt;

&lt;p&gt;&lt;em&gt;三个节点都执行&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-sSL&lt;/span&gt; https://github.com/coreos/etcd/releases/download/v3.0.4/etcd-v3.0.4-linux-amd64.tar.gz|tar &lt;span class=&quot;nt&quot;&gt;-xvf&lt;/span&gt; - &lt;span class=&quot;nt&quot;&gt;--gzip&lt;/span&gt;
cp &lt;span class=&quot;nt&quot;&gt;-af&lt;/span&gt; etcd-v3.0.4-linux-amd64/&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;etcd,etcdctl&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; /usr/local/bin
chmod +x /usr/local/bin/&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;etcd,etcdctl&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h4 id=&quot;二配置etcd&quot;&gt;二、配置etcd&lt;/h4&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/clustering.md&quot;&gt;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/clustering.md&lt;/a&gt;&lt;br /&gt;
cluster帮助文档&lt;br /&gt;
etcd-v3.0.4-linux-amd64/Documentation/op-guide/clustering.md&lt;br /&gt;
This guide will cover the following mechanisms for bootstrapping an etcd cluster:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;#static&quot;&gt;Static&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#etcd-discovery&quot;&gt;etcd Discovery&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#dns-discovery&quot;&gt;DNS Discovery&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;目前支持三种发现方式，Static适用于有固定IP的主机节点，etcd Discovery适用于DHCP环境，DNS Discovery依赖DNS SRV记录&lt;/p&gt;

&lt;p&gt;&lt;em&gt;提示：etcd支持ssl/tls,详见官方文档&lt;br /&gt;
&lt;a href=&quot;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/security.md&quot;&gt;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/security.md&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;以下使用static方式&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;节点一: etcd0: 192.168.8.101&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd0 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-advertise-peer-urls&lt;/span&gt; http://192.168.8.101:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.101:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.101:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.101:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-token&lt;/span&gt; etcd-cluster-1 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;etcd0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380,etcd1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380,etcd2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-state&lt;/span&gt; new
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;节点二: etcd1: 192.168.8.102&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd1 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-advertise-peer-urls&lt;/span&gt; http://192.168.8.102:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.102:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.102:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.102:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-token&lt;/span&gt; etcd-cluster-1 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;etcd0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380,etcd1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380,etcd2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-state&lt;/span&gt; new
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;节点三: etcd2: 192.168.8.103&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd2 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-advertise-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.103:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.103:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-token&lt;/span&gt; etcd-cluster-1 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;etcd0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380,etcd1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380,etcd2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--initial-cluster-state&lt;/span&gt; new 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;说明&lt;/strong&gt;&lt;br /&gt;
2379 是用于监听客户端请求，2380 用于集群通信，–data-dir指定数据存放目录&lt;br /&gt;
注意:&lt;br /&gt;
上面的初始化只是在集群初始化时运行一次，之后服务有重启，必须要去除掉initial参数，否则报错。&lt;br /&gt;
请使用如下类似命令:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd2   &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.103:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.103:2379 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;三systemd管控&quot;&gt;三、systemd管控&lt;/h4&gt;

&lt;p&gt;创建 etcd.service  （以 etcd0 为例）&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/lib/systemd/system/etcd.service &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;HERE&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
WorkingDirectory=/opt/etcd/
ExecStart=/usr/local/bin/etcd --name etcd0 --data-dir /opt/etcd \
  --initial-advertise-peer-urls http://192.168.8.101:2380 \
  --listen-peer-urls http://192.168.8.101:2380 \
  --listen-client-urls http://192.168.8.101:2379,http://127.0.0.1:2379 \
  --advertise-client-urls http://192.168.8.101:2379 \
  --initial-cluster-token etcd-cluster-1 \
  --initial-cluster etcd0=http://192.168.8.101:2380,etcd1=http://192.168.8.102:2380,etcd2=http://192.168.8.103:2380 \
  --initial-cluster-state new
Restart=on-failure
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;启动etcd服务&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;etcd
Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /usr/lib/systemd/system/etcd.service.
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# systemctl start etcd
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# systemctl status etcd
●etcd.service - Etcd Server
  Loaded: loaded &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;/usr/lib/systemd/system/etcd.service&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; enabled&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; vendor preset: disabled&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  Active: active &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;running&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; since 2018-01-23 15:06:30 CST&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; 8min ago
 Main PID: 12099 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;etcd&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  CGroup: /system.slice/etcd.service
         └─12099 /usr/local/bin/etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd0 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd
......
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;etcd集群管理&quot;&gt;etcd集群管理&lt;/h3&gt;

&lt;p&gt;官方地址&lt;br /&gt;
&lt;a href=&quot;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/maintenance.md&quot;&gt;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/maintenance.md&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nt&quot;&gt;--version&lt;/span&gt;
etcdctl version: 3.0.4
 
 
API version: 2
COMMANDS:
    backup         backup an etcd directory
    cluster-health  check the health of the etcd cluster
    mk            make a new key with a given value
    mkdir          make a new directory
    rm            remove a key or a directory
    rmdir          removes the key &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;it is an empty directory or a key-value pair
    get           retrieve the value of a key
    &lt;span class=&quot;nb&quot;&gt;ls            &lt;/span&gt;retrieve a directory
    &lt;span class=&quot;nb&quot;&gt;set           set &lt;/span&gt;the value of a key
    setdir         create a new directory or update an existing directory TTL
    update         update an existing key with a given value
    updatedir      update an existing directory
    watch          watch a key &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;changes
    exec-watch     watch a key &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;changes and &lt;span class=&quot;nb&quot;&gt;exec &lt;/span&gt;an executable
    member         member add, remove and list subcommands
    import         import a snapshot to a cluster
    user          user add, grant and revoke subcommands
    role          role add, grant and revoke subcommands
    auth          overall auth controls
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;一集群健康状态&quot;&gt;一、集群健康状态&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl cluster-health
member 2947dd07df9e44da is healthy: got healthy result from http://192.168.8.102:2379
member 571bf93ce7760601 is healthy: got healthy result from http://192.168.8.101:2379
member b200a8bec19bd22e is healthy: got healthy result from http://192.168.8.103:2379
cluster is healthy
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;二集群成员查看&quot;&gt;二、集群成员查看&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl member list
2947dd07df9e44da: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd1 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;571bf93ce7760601: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd0 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;b200a8bec19bd22e: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd2 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;三删除集群成员&quot;&gt;三、删除集群成员&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member remove b200a8bec19bd22e 
Removed member 4d11141f72b2744c from cluster
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member list
2947dd07df9e44da: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd1 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;571bf93ce7760601: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd0 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;四添加集群成员&quot;&gt;四、添加集群成员&lt;/h4&gt;
&lt;p&gt;官方说明：
&lt;a href=&quot;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/runtime-configuration.md&quot;&gt;https://github.com/coreos/etcd/blob/master/Documentation/op-guide/runtime-configuration.md&lt;/a&gt;&lt;br /&gt;
&lt;em&gt;注意:步骤很重要，不然会报集群ID不匹配&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member add &lt;span class=&quot;nt&quot;&gt;--help&lt;/span&gt;
NAME:
  etcdctl member add - add a new member to the etcd cluster
USAGE:
  etcdctl member add
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;1.将目标节点添加到集群&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member add etcd2 http://192.168.8.103:2380
Added member named etcd2 with ID 28e0d98e7ec15cd4 to cluster

&lt;span class=&quot;nv&quot;&gt;ETCD_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;etcd2&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_INITIAL_CLUSTER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;etcd2=http://192.168.8.103:2380,etcd1=http://192.168.8.102:2380,etcd0=http://192.168.8.101:2380&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_INITIAL_CLUSTER_STATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;existing&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member list
2947dd07df9e44da: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd1 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;571bf93ce7760601: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd0 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;d4f257d2b5f99b64[unstarted]: &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;此时，集群会为目标节点生成一个唯一的member ID&lt;/p&gt;

&lt;p&gt;2.清空目标节点的data-dir&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]#rm &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; /opt/etcd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;注意:节点删除后，集群中的成员信息会更新，新节点加入集群是作为一个全新的节点加入，如果data-dir有数据，etcd启动时会读取己经存在的数据，启动时仍然用的老member ID,也会造成，集群不无法加入，所以一定要清空新节点的data-dir&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;2016-08-12 01:59:41.084928 E | rafthttp: failed to find member 2947dd07df9e44da &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;cluster ce2f2517679629de
2016-08-12 01:59:41.133698 W | rafthttp: failed to process raft message &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;raft: stopped&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
2016-08-12 01:59:41.135746 W | rafthttp: failed to process raft message &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;raft: stopped&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
2016-08-12 01:59:41.170915 E | rafthttp: failed to find member 2947dd07df9e44da &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;cluster ce2f2517679629de
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.在目标节点上启动etcd&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd2 &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; /opt/etcd &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--initial-advertise-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://192.168.8.103:2379,http://127.0.0.1:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://192.168.8.103:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--initial-cluster-token&lt;/span&gt; etcd-cluster-1 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--initial-cluster&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;etcd0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380,etcd1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380,etcd2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
 &lt;span class=&quot;nt&quot;&gt;--initial-cluster-state&lt;/span&gt; existing
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;em&gt;注意:这里的initial标记一定要指定为existing,如果为new则会自动生成一个新的member ID,和前面添加节点时生成的ID不一致，故日志中会报节点ID不匹配的错&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl member list
28e0d98e7ec15cd4: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd2 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.103:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;2947dd07df9e44da: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd1 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.102:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false
&lt;/span&gt;571bf93ce7760601: &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd0 &lt;span class=&quot;nv&quot;&gt;peerURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2380 &lt;span class=&quot;nv&quot;&gt;clientURLs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://192.168.8.101:2379 &lt;span class=&quot;nv&quot;&gt;isLeader&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;五增删改查&quot;&gt;五、增删改查&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;foo &lt;span class=&quot;s2&quot;&gt;&quot;bar&quot;&lt;/span&gt;
bar
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl get foo
bar
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl mkdir hello
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt;
/foo
/hello
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt; extended get foo
Key: /foo
Created-Index: 9
Modified-Index: 9
TTL: 0
Index: 10
bar
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl &lt;span class=&quot;nt&quot;&gt;--output&lt;/span&gt; json get foo
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;get&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;node&quot;&lt;/span&gt;:&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/foo&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;value&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;bar&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;nodes&quot;&lt;/span&gt;:null,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:9,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:9&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;prevNode&quot;&lt;/span&gt;:null&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl update foo &lt;span class=&quot;s2&quot;&gt;&quot;etcd cluster is ok&quot;&lt;/span&gt;
etcd cluster is ok
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node2 ~]# etcdctl get foo
etcd cluster is ok
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node3 ~]# etcdctl import &lt;span class=&quot;nt&quot;&gt;--snap&lt;/span&gt;/opt/etcd/member/snap/db 
starting to import snapshot /opt/etcd/member/snap/db with 10 clients
2016-08-12 01:18:17.281921 I | entering dir: /
finished importing 0 keys
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h4 id=&quot;rest-api&quot;&gt;REST API&lt;/h4&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/coreos/etcd/tree/master/Documentation/learning&quot;&gt;https://github.com/coreos/etcd/tree/master/Documentation/learning&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# curl 192.168.8.101:2379/v2/keys 
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;get&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;node&quot;&lt;/span&gt;:&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;dir&quot;&lt;/span&gt;:true,&lt;span class=&quot;s2&quot;&gt;&quot;nodes&quot;&lt;/span&gt;:[&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/foo&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;value&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;etcd cluster is ok&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:28,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:9&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/hello&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;dir&quot;&lt;/span&gt;:true,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:10,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:10&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/registry&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;dir&quot;&lt;/span&gt;:true,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:47,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:47&lt;span class=&quot;o&quot;&gt;}]}}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# curl &lt;span class=&quot;nt&quot;&gt;-fs&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-X&lt;/span&gt; PUT 192.168.8.101:2379/v2/keys/_test
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;set&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;node&quot;&lt;/span&gt;:&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/_test&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;value&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:1439,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:1439&lt;span class=&quot;o&quot;&gt;}}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@node1 ~]# curl &lt;span class=&quot;nt&quot;&gt;-X&lt;/span&gt; GET 192.168.8.101:2379/v2/keys/_test
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;action&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;get&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;node&quot;&lt;/span&gt;:&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;key&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;/_test&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;value&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;modifiedIndex&quot;&lt;/span&gt;:1439,&lt;span class=&quot;s2&quot;&gt;&quot;createdIndex&quot;&lt;/span&gt;:1439&lt;span class=&quot;o&quot;&gt;}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Barry New</name></author><summary type="html">etcd 是 kubernetes 中默认使用的键值存储系统，相当于是 kubernetes 集群的大脑，那么 etcd 怎么安装使用呢？下面为常用的集群配置及基本操作。</summary></entry><entry><title type="html">nip.io域名的使用</title><link href="https://kago.site/2017/12/29/nipio/" rel="alternate" type="text/html" title="nip.io域名的使用" /><published>2017-12-29T00:00:00+08:00</published><updated>2017-12-29T00:00:00+08:00</updated><id>https://kago.site/2017/12/29/nipio</id><content type="html" xml:base="https://kago.site/2017/12/29/nipio/">&lt;blockquote&gt;
  &lt;p&gt;昨天小毛同学告诉我说发现一个很流弊的东西叫 nip.io，可以凭域名自动解析为 IP 地址，极大的方便了 kubernetes 中 ingress 部分的测试。在 cmd 中试了一下还真是好用，记录一下~&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;官方介绍&quot;&gt;官方介绍&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;NIP.IO

Dead simple wildcard DNS for any IP Address

NIP.IO allows you to map any IP Address in the following DNS wildcard entries:

10.0.0.1.nip.io maps to 10.0.0.1
app.10.0.0.1.nip.io maps to 10.0.0.1
customer1.app.10.0.0.1.nip.io maps to 10.0.0.1
customer2.app.10.0.0.1.nip.io maps to 10.0.0.1
otherapp.10.0.0.1.nip.io maps to 10.0.0.1

NIP.IO maps &amp;lt;anything&amp;gt;.&amp;lt;IP Address&amp;gt;.nip.io to the corresponding &amp;lt;IP Address&amp;gt;, even 127.0.0.1.nip.io maps to 127.0.0.1


This service is a blatant rip-off of xip.io, with one big difference: NIP.IO is powered by PowerDNS with a simple, custom PipeBackend. So, it actually works :) (no messy, custom DNS server here!)

The custom PipeBackend is a single script written in Python and the source can be found on XP-Dev.com.

This is a free service provided by Exentrique Solutions (the same guys who run XP-Dev.com which offers Git, Mercurial and Subversion hosting). The infrastructure runs on a couple of Virtual Machines in the US West Coast and Germany.

Feedback is appreciated, just drop us a mail at info@exentriquesolutions.com or use this web form.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;原来 nip.io 像 xip.io 一样是一个欺骗性的映射，可以方便的把 xxx.192.168.1.1.nip.io 这样的域名解析成 192.168.1.1 ，在 web 测试中十分方便。不必频繁地修改 DNS 或者 hosts 文件即可实现域名解析为 IP 地址，尤其在 kubernetes 环境中配置 ingress 的 hosts 部分。
xip.io 和 nip.io 还有一个区别是，nip.io 后端是有 powerDNS ，是实际发生了解析操作。&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;注意：离线模式下不可用哦~&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;实测&quot;&gt;实测&lt;/h3&gt;

&lt;p&gt;使用 cmd 对域名进行了简单测试，结果如下：
&lt;img src=&quot;/images/posts/nipio.png&quot; alt=&quot;cmd测试截图&quot; /&gt;&lt;/p&gt;</content><author><name>Barry New</name></author><summary type="html">昨天小毛同学告诉我说发现一个很流弊的东西叫 nip.io，可以凭域名自动解析为 IP 地址，极大的方便了 kubernetes 中 ingress 部分的测试。在 cmd 中试了一下还真是好用，记录一下~</summary></entry><entry><title type="html">jekyll中添加gitment留言板</title><link href="https://kago.site/2017/12/09/gitment/" rel="alternate" type="text/html" title="jekyll中添加gitment留言板" /><published>2017-12-09T00:00:00+08:00</published><updated>2017-12-09T00:00:00+08:00</updated><id>https://kago.site/2017/12/09/gitment</id><content type="html" xml:base="https://kago.site/2017/12/09/gitment/">&lt;h1 id=&quot;前言&quot;&gt;前言&lt;/h1&gt;
&lt;p&gt;最近使用jekyll搭建了个人博客（https://kago.site），参考网友资料为博客添加了gitment作为留言板，罗列一下基本步骤，希望可以帮到大家。&lt;/p&gt;

&lt;h1 id=&quot;申请github-oauth-application&quot;&gt;申请Github OAuth Application&lt;/h1&gt;
&lt;p&gt;Github头像下拉菜单 &amp;gt; Settings &amp;gt; 左边Developer settings下的OAuth Apps &amp;gt; New OAuth App，填写相关信息：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;Application name, Homepage URL, Application description 都可以随意填写&lt;/li&gt;
  &lt;li&gt;Authorization callback URL 一定要写自己Github Pages的URL&lt;/li&gt;
  &lt;li&gt;填写完上述信息后按Register application按钮，得到Client ID和Client Secret&lt;/li&gt;
  &lt;li&gt;记录Client ID和Client Secret，稍后会用到&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;在jekyll添加调用gitment&quot;&gt;在jekyll添加调用gitment&lt;/h1&gt;
&lt;p&gt;在_layout/目录下的 post.html, 添加一下代码：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;div id=&quot;gitmentContainer&quot;&amp;gt;&amp;lt;/div&amp;gt;
&amp;lt;link rel=&quot;stylesheet&quot; href=&quot;https://imsun.github.io/gitment/style/default.css&quot;&amp;gt;
&amp;lt;script src=&quot;https://imsun.github.io/gitment/dist/gitment.browser.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
&amp;lt;script&amp;gt;
var gitment = new Gitment({
    owner: 'Your GitHub username',
    repo: 'The repo to store comments',
    oauth: {
        client_id: 'Your client ID',
        client_secret: 'Your client secret',
    },
});
gitment.render('gitmentContainer');
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;需要修改的有4个地方&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Your GitHub username：填写你的Github Pages博客所在的github账户名&lt;/li&gt;
  &lt;li&gt;The repo to store comments：填写用来存放评论的github仓库，由于评论是 通过issues来存放的，个人建议这里可以直接填Github Pages个人博客所在的仓库&lt;/li&gt;
  &lt;li&gt;Your client ID：上一步所申请到的应用的Client ID&lt;/li&gt;
  &lt;li&gt;Your client secret：上一步所申请到的应用的Client Secret&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;填写完这4项把代码push到github。&lt;/p&gt;

&lt;h1 id=&quot;为博客初始化留言板&quot;&gt;为博客初始化留言板&lt;/h1&gt;
&lt;p&gt;gitment的原理是为每一遍博文以其URL作为标识创建一个github issue， 对该篇博客的评论就是对这个issue的评论。因此，需要对博客初始化， 初始化后，评论信息会添加到github上对应的issue。&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;上传代码成功后，博客文章下方会出现留言板，显示&lt;code class=&quot;highlighter-rouge&quot;&gt;Error: Comments Not Initialized&lt;/code&gt;,提示需要初始化&lt;/li&gt;
  &lt;li&gt;点击&lt;code class=&quot;highlighter-rouge&quot;&gt;login with github&lt;/code&gt;,使用自己github账号登录，错误信息会变成&lt;code class=&quot;highlighter-rouge&quot;&gt;Initialize Comments&lt;/code&gt;按钮&lt;/li&gt;
  &lt;li&gt;点击按钮，完成对博文的初始化，同时创建相应的issue
&lt;img src=&quot;/images/posts/gitment/gitment.png&quot; alt=&quot;gitment&quot; /&gt;&lt;/li&gt;
&lt;/ol&gt;</content><author><name>Barry New</name></author><summary type="html">前言 最近使用jekyll搭建了个人博客（https://kago.site），参考网友资料为博客添加了gitment作为留言板，罗列一下基本步骤，希望可以帮到大家。</summary></entry><entry><title type="html">mariadb的主从复制、主主复制、半同步复制的概念和方法</title><link href="https://kago.site/2017/11/19/mariadb-replicate/" rel="alternate" type="text/html" title="mariadb的主从复制、主主复制、半同步复制的概念和方法" /><published>2017-11-19T00:00:00+08:00</published><updated>2017-11-19T00:00:00+08:00</updated><id>https://kago.site/2017/11/19/mariadb-replicate</id><content type="html" xml:base="https://kago.site/2017/11/19/mariadb-replicate/">&lt;p&gt;这篇文章主要详细介绍了mariadb的主从复制、主主复制、半同步复制的概念和方法。&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;参考&lt;a href=&quot;http://www.jb51.net/article/97786.htm&quot;&gt;http://www.jb51.net/article/97786.htm&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;主从服务器的时间要同步，数据库版本最好是一致的，以免造成函数处理、日志读取、日志解析等发生异常。
以下三个主从复制的设置是独立的。
注意防火墙和selinux的影响。&lt;/p&gt;

&lt;h1 id=&quot;1简单主从复制的实现&quot;&gt;&lt;strong&gt;1、简单主从复制的实现&lt;/strong&gt;&lt;/h1&gt;

&lt;h2 id=&quot;11-服务器1操作&quot;&gt;1.1 服务器1操作&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;编辑/etc/my.cnf文件&lt;/p&gt;

    &lt;p&gt;在[mysqld]段的最后添加以下内容&lt;/p&gt;
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON    
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 1 &lt;span class=&quot;c&quot;&gt;#id号不能跟从服务器相同&lt;/span&gt;
log-bin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; master-log &lt;span class=&quot;c&quot;&gt;#自定义二进制日志文件名&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;授权可以复制本地数据库信息的主机
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service &lt;span class=&quot;c&quot;&gt;#启动mariadb server   &lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; grant replication slave,replication client on &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to &lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'10.1.51.%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; flush privileges&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;   
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show master status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#查看主服务器的状态信息，在从服务器中要用到&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
File: master-log.000003 &lt;span class=&quot;c&quot;&gt;#正在使用的二进制日志文件&lt;/span&gt;
Position: 497 &lt;span class=&quot;c&quot;&gt;#所处的位置&lt;/span&gt;
Binlog_Do_DB:
Binlog_Ignore_DB:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;12-从服务器的配置&quot;&gt;1.2 从服务器的配置&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;编辑/etc/my.cnf文件&lt;/p&gt;

    &lt;p&gt;在[mysqld]段的最后添加以下内容&lt;/p&gt;
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2 &lt;span class=&quot;c&quot;&gt;#id号不能跟主服务器相同）&lt;/span&gt;
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log &lt;span class=&quot;c&quot;&gt;#自定义二进制日志文件名）&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;设置要从哪个主服务器的那个位置开始同步
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; change master to &lt;span class=&quot;nv&quot;&gt;master_host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'10.1.51.60'&lt;/span&gt;,master_user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;,master_password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;,master_log_file&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'master-log.000003'&lt;/span&gt;,master_log_pos&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;497&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#启动复制功能&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show slave status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#查看从服务器的状态，下面显示的是部分内容&lt;/span&gt;
Master_Host: 10.1.51.60
Master_User: repluser
Master_Port: 3306
Connect_Retry: 60
Master_Log_File: master-log.000003
Read_Master_Log_Pos: 497
Relay_Log_File: slave-log.000002
Relay_Log_Pos: 530
Relay_Master_Log_File: master-log.000003
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
Master_Server_Id: 1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;13-测试&quot;&gt;1.3 测试&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;在主服务器导入事先准备好的数据库
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql &amp;lt; hellodb.sql
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在从服务器查看是否同步
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show databases&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+--------------------+
| Database   |
+--------------------+
| information_schema |
| hellodb   | &lt;span class=&quot;c&quot;&gt;#数据库已经同步&lt;/span&gt;
| mysql    |
| performance_schema |
| &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;    |
+--------------------+
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; use hellodb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; show tables&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#hellodb数据库的表也是同步的&lt;/span&gt;
+-------------------+
| Tables_in_hellodb |
+-------------------+
| classes   |
| coc    |
| courses   |
| scores   |
| students   |
| teachers   |
| toc    |
+-------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;2双主复制的实现&quot;&gt;&lt;strong&gt;2、双主复制的实现&lt;/strong&gt;&lt;/h1&gt;

&lt;h2 id=&quot;21-安装mariadb&quot;&gt;2.1 安装MariaDB&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;服务器1的操作：&lt;/li&gt;
&lt;/ul&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf文件
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;在[mysqld]段的最后添加以下内容&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 1 &lt;span class=&quot;c&quot;&gt;#id号不能跟从服务器相同&lt;/span&gt;
log-bin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; master-log &lt;span class=&quot;c&quot;&gt;#自定义主服务器的二进制日志文件名&lt;/span&gt;
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log &lt;span class=&quot;c&quot;&gt;#自定义从服务器的二进制日志文件名&lt;/span&gt;
auto_increment_offset &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 1 
auto_increment_increment &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;启动服务
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service	
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]#systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;mariadb.servic
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;服务器2的操作：&lt;/em&gt;&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf文件
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log
lob-bin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; master-log
auto_increment_offset &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2 
auto_increment_increment &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;启动服务
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service	
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]#systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;mariadb.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;22-配置双主复制&quot;&gt;2.2 配置双主复制&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;在服务器2上查看的master状态&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;说明：记录数据，在服务器2上配置时会用到。&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show master status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
File: master-log.000003
Position: 521
Binlog_Do_DB:
Binlog_Ignore_DB:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;服务器1上进行如下配置&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;说明：以下配置的内容为服务器2的IP及服务器2上查到的master数据。&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; grant replication slave,replication client on &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to &lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'192.168.1.%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; change master to &lt;span class=&quot;nv&quot;&gt;master_host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.1.188'&lt;/span&gt;,master_user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;,master_password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;,master_log_file&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'master-log.000003'&lt;/span&gt;,master_log_pos&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;521&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; SHOW SLAVE STATUS&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
              Slave_IO_State: Waiting &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;master to send event
                  Master_Host: 192.168.1.188
                  Master_User: repluser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: master-log.000003
          Read_Master_Log_Pos: 521
              Relay_Log_File: slave-log.000002
                Relay_Log_Pos: 806
        Relay_Master_Log_File: master-log.000003
            Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB:
          Replicate_Ignore_DB:
          Replicate_Do_Table:
      Replicate_Ignore_Table:
      Replicate_Wild_Do_Table:
  Replicate_Wild_Ignore_Table:
                  Last_Errno: 0
                  Last_Error:
                Skip_Counter: 0
          Exec_Master_Log_Pos: 521
              Relay_Log_Space: 1094
              Until_Condition: None
              Until_Log_File:
                Until_Log_Pos: 0
          Master_SSL_Allowed: No
          Master_SSL_CA_File:
          Master_SSL_CA_Path:
              Master_SSL_Cert:
            Master_SSL_Cipher:
              Master_SSL_Key:
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error:
              Last_SQL_Errno: 0
              Last_SQL_Error:
  Replicate_Ignore_Server_Ids:
            Master_Server_Id: 2
1 row &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.00 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;在服务器1查看master状态
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show master status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
File: master-log.000003
Position: 795
Binlog_Do_DB: 
Binlog_Ignore_DB:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;服务器2上进行如下配置&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;说明：以下的配置内容为服务器1的IP及服务器1中查到的master信息&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; grant replication slave,replication client on &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to &lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'192.168.1.%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; change master to &lt;span class=&quot;nv&quot;&gt;master_host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.1.187'&lt;/span&gt;,master_user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;,master_password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;,master_log_file&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'master-log.000003'&lt;/span&gt;,master_log_pos&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;795&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show slave status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
              Slave_IO_State: Waiting &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;master to send event
                  Master_Host: 192.168.1.187
                  Master_User: repluser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: master-log.000003
          Read_Master_Log_Pos: 795
              Relay_Log_File: slave-log.000002
                Relay_Log_Pos: 530
        Relay_Master_Log_File: master-log.000003
            Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB:
          Replicate_Ignore_DB:
          Replicate_Do_Table:
      Replicate_Ignore_Table:
      Replicate_Wild_Do_Table:
  Replicate_Wild_Ignore_Table:
                  Last_Errno: 0
                  Last_Error:
                Skip_Counter: 0
          Exec_Master_Log_Pos: 795
              Relay_Log_Space: 818
              Until_Condition: None
              Until_Log_File:
                Until_Log_Pos: 0
          Master_SSL_Allowed: No
          Master_SSL_CA_File:
          Master_SSL_CA_Path:
              Master_SSL_Cert:
            Master_SSL_Cipher:
              Master_SSL_Key:
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error:
              Last_SQL_Errno: 0
              Last_SQL_Error:
  Replicate_Ignore_Server_Ids:
            Master_Server_Id: 1
1 row &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0.00 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;23-测试&quot;&gt;2.3 测试&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;在任意一台服务器上创建mydb数据库
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; create database mydb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在另一台服务器上查看
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show databases&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+--------------------+
| Database   |
+--------------------+
| information_schema |
| mydb    |
| mysql    |
| performance_schema |
| &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;    |
+--------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;3半同步复制的实现&quot;&gt;&lt;strong&gt;3、半同步复制的实现&lt;/strong&gt;&lt;/h1&gt;

&lt;h2 id=&quot;31-在主服务器上的配置&quot;&gt;3.1 在主服务器上的配置&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
 skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
 innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
 server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 1
 log-bin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; master-log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;授权可以复制本地数据库信息的主机&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service &lt;span class=&quot;c&quot;&gt;#启动mariadb server&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; grant replication slave,replication client on &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; to &lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'10.1.51.%'&lt;/span&gt; identified by &lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; flush privileges&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show master status&lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;#查看主服务器的状态信息，在从服务器中要用到&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt; 1. row &lt;span class=&quot;k&quot;&gt;***************************&lt;/span&gt;
File: master-log.000003 &lt;span class=&quot;c&quot;&gt;#正在使用的二进制日志文件&lt;/span&gt;
Position: 245 &lt;span class=&quot;c&quot;&gt;#所处的位置&lt;/span&gt;
Binlog_Do_DB:
Binlog_Ignore_DB:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;安装rpl semi sync_master插件，并启用
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; install plugin rpl_semi_sync_master soname &lt;span class=&quot;s1&quot;&gt;'semisync_master.so'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;global rpl_semi_sync_master_enabled &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show plugins&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#可查看插件是否激活&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show global variables like &lt;span class=&quot;s1&quot;&gt;'rpl_semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#可查看安装的插件是否启用&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show global status like &lt;span class=&quot;s1&quot;&gt;'%semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#可查看从服务器的个数，此时是0个&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;32从服务器的配置&quot;&gt;3.2从服务器的配置&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;安装mariadb-server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# yum &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; install mariadb-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf文件
在[mysqld]段的最后添加以下内容
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2 &lt;span class=&quot;c&quot;&gt;#id号不能跟主服务器相同&lt;/span&gt;
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log &lt;span class=&quot;c&quot;&gt;#自定义二进制日志文件名&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;设置要从哪个主服务器的那个位置开始同步
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service 
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql 
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; change master to &lt;span class=&quot;nv&quot;&gt;master_host&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'10.1.51.60'&lt;/span&gt;,master_user&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'repluser'&lt;/span&gt;,master_password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'replpasswd'&lt;/span&gt;,master_log_file&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'master-log.000003'&lt;/span&gt;,master_log_pos&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;245&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;安装rpl semi sync_slave插件并启用
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# mysql 
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; install plugin rpl_semi_sync_slave soname &lt;span class=&quot;s1&quot;&gt;'semisync_slave.so'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;global rpl_semi_sync_slave_enabled &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;完成上面配置后，可以在主服务器上查看半同步复制的相关信息，命令如下：&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show global status like &lt;span class=&quot;s1&quot;&gt;'%semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
Rpl_semi_sync_master_clients 1 &lt;span class=&quot;c&quot;&gt;#从服务器有一台&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;33-测试&quot;&gt;3.3 测试&lt;/h3&gt;

&lt;p&gt;测试以个人实际情况而定&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;在主服务器上导入事先准备好的数据库hellodb.sql
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt; /root/hellodb.sql&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在主服务器上查看半同步复制的状态&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; show master status&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+-------------------+----------+--------------+------------------+
| File    | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+-------------------+----------+--------------+------------------+
| master-log.000003 |  8102 |    |     |
+-------------------+----------+--------------+------------------+ 
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; show global status like &lt;span class=&quot;s1&quot;&gt;'%semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+--------------------------------------------+-------+
| Variable_name        | Value |
+--------------------------------------------+-------+
| Rpl_semi_sync_master_clients    | 1  |
| Rpl_semi_sync_master_net_avg_wait_time  | 1684 |
| Rpl_semi_sync_master_net_wait_time   | 60630 |
| Rpl_semi_sync_master_net_waits    | 36 |
| Rpl_semi_sync_master_no_times    | 1  |
| Rpl_semi_sync_master_no_tx     | 1  |
| Rpl_semi_sync_master_status    | ON |
| Rpl_semi_sync_master_timefunc_failures  | 0  |
| Rpl_semi_sync_master_tx_avg_wait_time  | 1884 |
| Rpl_semi_sync_master_tx_wait_time   | 65965 |
| Rpl_semi_sync_master_tx_waits    | 35 |
| Rpl_semi_sync_master_wait_pos_backtraverse | 0  |
| Rpl_semi_sync_master_wait_sessions   | 0  |
| Rpl_semi_sync_master_yes_tx    | 35 |
+--------------------------------------------+-------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;在从服务器上查看是否同步
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show databases&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; use hellodb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; &lt;span class=&quot;k&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; from students&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;4-补充&quot;&gt;&lt;strong&gt;4 补充：&lt;/strong&gt;&lt;/h1&gt;

&lt;p&gt;基于上面的半同步复制配置复制的过滤器，复制过滤最好在从服务器上设置，步骤如下&lt;/p&gt;

&lt;h2 id=&quot;41-从服务器的配置&quot;&gt;4.1 从服务器的配置&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;关闭mariadb server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl stop mariadb.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;编辑/etc/my.cnf文件
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# vim /etc/my.cnf
skip_name_resolve &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
innodb_file_per_table &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON
server-id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2
relay-log &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; slave-log
replicate-do-db &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; mydb &lt;span class=&quot;c&quot;&gt;#只复制mydb数据库的内容&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;补充：常用的过滤选项如下&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;Replicate_Do_DB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Ignore_DB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Do_Table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Ignore_Table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Wild_Do_Table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Replicate_Wild_Ignore_Table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;重启mariadb server
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@localhost ~]# systemctl start mariadb.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;重启mariadb server后，半同步复制功能将被关闭，因此要重新启动&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; show global variables like &lt;span class=&quot;s1&quot;&gt;'%semi%'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
+---------------------------------+-------+
| Variable_name     | Value |
+---------------------------------+-------+
| rpl_semi_sync_slave_enabled  | OFF |
| rpl_semi_sync_slave_trace_level | 32 |
+---------------------------------+-------+
 
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;global rpl_semi_sync_slave_enabled &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ON&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; stop slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#需先关闭从服务器复制功能再重启&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;42测试&quot;&gt;4.2测试&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;主服务器上的hellodb数据库创建一个新表semitable
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; create table semitable &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;id int&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在从服务器上查看hellodb数据库是否有semitable
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; use hellodb
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; show tables&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;（并没有）
+-------------------+
| Tables_in_hellodb |
+-------------------+
| classes   |
| coc    |
| courses   |
| scores   |
| students   |
| teachers   |
| toc    |
+-------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在主服务器上创建mydb数据库，并为其创建一个tbl1表
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; create database mydb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在从服务器上查看mydb数据库的是否有tbl1表
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hellodb]&amp;gt; use mydb&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;mydb]&amp;gt; show tables&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; （可以查看到）
+----------------+
| Tables_in_mydb |
+----------------+
| tbl1   |
+----------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;</content><author><name>Barry New</name></author><summary type="html">这篇文章主要详细介绍了mariadb的主从复制、主主复制、半同步复制的概念和方法。 参考http://www.jb51.net/article/97786.htm</summary></entry><entry><title type="html">没想到是这样的…</title><link href="https://kago.site/2017/11/19/mypets/" rel="alternate" type="text/html" title="没想到是这样的..." /><published>2017-11-19T00:00:00+08:00</published><updated>2017-11-19T00:00:00+08:00</updated><id>https://kago.site/2017/11/19/mypets</id><content type="html" xml:base="https://kago.site/2017/11/19/mypets/">&lt;h3 id=&quot;罪恶的源头&quot;&gt;罪恶的源头&lt;/h3&gt;

&lt;p&gt;一切到要从漫画家&lt;a href=&quot;http://wuhuang-wanshui.lofter.com/&quot;&gt;白茶&lt;/a&gt;养的两只“明星”说起，一只叫“吾皇”，另一只叫“巴扎黑”&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/wuhuang.jpg&quot; alt=&quot;吾皇&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/bazhahei.jpg&quot; alt=&quot;巴扎黑&quot; /&gt;&lt;/p&gt;

&lt;p&gt;只怪当时太年轻，以为集齐了吾皇和巴扎黑就能得到整个世界，然而故事好像偏离了轨道…&lt;/p&gt;

&lt;h3 id=&quot;我可能养了一只猪&quot;&gt;我可能养了一只猪&lt;/h3&gt;

&lt;p&gt;记得巴扎黑来到家里的时间大概是今年的8月15号，是女朋友送给我的，只因为我和她说过喜欢白茶养的巴扎黑。因此，我们家的小巴哥犬的名字也叫成了巴扎黑，觉得更贴切一些（其实只是因为懒）。当时这只小巴哥犬才2个月多一点，狂犬疫苗还没接种，但是阻挡不了我对它的喜爱：水汪汪的大眼睛总是像别人欠它好几块骨头似的。&lt;/p&gt;

&lt;p&gt;话不多说，直接上图：&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/blog/xiaoshihoudebazhahei.jpg&quot; alt=&quot;巴扎黑刚来的时候&quot; /&gt;&lt;/p&gt;

&lt;p&gt;巴哥犬在狗界是出了名的贪吃，加上它还是只幼犬，每天只想着吃吃吃，虽然每天都在控制食量，但还是在不到三个月的时间体重由4斤飙至11斤。粗壮的体型加上吃饭是发出的声音神似一只小猪…难怪经常被保洁阿姨唤作“你家那头小猪”。
巴扎黑，就问你羞不羞！！
&lt;img src=&quot;/images/blog/hazhaheishafa.jpg&quot; alt=&quot;胖子巴扎黑&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;我才是老大&quot;&gt;我才是老大&lt;/h3&gt;

&lt;p&gt;有了巴扎黑怎么能没有吾皇，就在一个阳光明媚的下午，一只橘猫来到的我们家。
&lt;img src=&quot;/images/blog/mao.jpg&quot; alt=&quot;蛋挞&quot; /&gt;&lt;/p&gt;

&lt;p&gt;女朋友一只想养只猫，早先养了一只美短，一个星期后送给了同事。为了这事儿她和我念叨了好多次，尤其是当巴扎黑在家里大小便的时候……&lt;/p&gt;

&lt;p&gt;蛋挞，是一只橘猫，就是最常见的家猫，以胖闻名于猫界，耳边隐约响起“十只橘猫九只胖，还有一只压塌炕”。一个星期的时间真心是见到了什么叫做能吃，肚子已经圆鼓鼓的了还在不停的找吃的。&lt;/p&gt;

&lt;p&gt;最让人抓狂的是，这个小家伙不和人亲热，一副diaodiao的样子，哎就当你是老大吧&lt;/p&gt;

&lt;h3 id=&quot;每天上演猫狗大战&quot;&gt;每天上演猫狗大战&lt;/h3&gt;

&lt;p&gt;每每想到客厅的惨状眼角就泛起了泪花，还是不写了，万一忍不住来个巴扎黑炖蛋挞呢……
&lt;img src=&quot;/images/blog/maogoudazhan.jpg&quot; alt=&quot;猫狗大战&quot; /&gt;&lt;/p&gt;</content><author><name>Barry New</name></author><summary type="html">罪恶的源头</summary></entry></feed>